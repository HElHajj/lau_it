<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#016751">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAU Office Support</title>
    <link rel="icon" href="pics/lau_icon.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>

</head>
<body class="selection-page-body">
    <header>
        <a href="index.html" class="back-button" aria-label="Go back to homepage">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="back-arrow-icon">
                <path fill-rule="evenodd" d="M15.707 5.293a1 1 0 010 1.414L10.414 12l5.293 5.293a1 1 0 01-1.414 1.414l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
        </a>
        <img src="pics/lau_logo.png" alt="University Logo" class="logo" width="150" height="60">
        <h1 id="pageTitle">Office Support</h1>
        <div class="header-controls">
            </div>
    </header>

    <main id="mainContent" class="selection-container">
        
        <div class="office-form-container" id="actualOfficeFormContainer" style="display: none;">
            <h2>Report an Issue</h2>
            <form id="officeIssueForm">
                <div>
                    <label for="userName">User Name <span class="required-star">*</span></label>
                    <input type="text" id="userName" name="userName" placeholder="Enter your full name" required>
                </div>
                <div>
                    <label for="extensionNumber">Extension Number <span class="required-star">*</span></label>
                    <input type="tel" id="extensionNumber" name="extensionNumber" placeholder="e.g., 1234" required>
                </div>
                <div>
                    <label for="officeBuilding">Building <span class="required-star">*</span></label>
                    <select id="officeBuilding" name="officeBuilding" required>
                        <option value="">Select Building...</option>
                        <option value="Adnan Kassar School of Business">Adnan Kassar School of Business</option>
                        <option value="Beirut Underground Parking">Beirut Underground Parking</option>
                        <option value="Executive Center at BCD">Executive Center at BCD</option>
                        <option value="Gezairi Building">Gezairi Building</option>
                        <option value="Irwin Hall">Irwin Hall</option>
                        <option value="Joseph G. Jabbra Gymnasium">Joseph G. Jabbra Gymnasium</option>
                        <option value="Nicol Hall">Nicol Hall</option>
                        <option value="Orme-Gray">Orme-Gray</option>
                        <option value="Riyad Nassar Library">Riyad Nassar Library</option>
                        <option value="Safadi Fine Arts">Safadi Fine Arts</option>
                        <option value="Sage Hall">Sage Hall</option>
                        <option value="Shannon Hall">Shannon Hall</option>
                        <option value="University Services">University Services</option>
                        <option value="Wadad Sabbagh Khoury Student Center">Wadad Sabbagh Khoury Student Center</option>
                        <option value="Santona Residence">Santona Residence</option>
                        <option value="Sarraf Building">Sarraf Building</option>
                        <option value="Animal Facility">Animal Facility</option>
                        <option value="Architecture Hall">Architecture Hall</option>
                        <option value="Block A Building">Block A Building</option>
                        <option value="Byblos Underground Parking">Byblos Underground Parking</option>
                        <option value="Cafeteria">Cafeteria</option>
                        <option value="Engineering Laboratories and Research Center">Engineering Laboratories and Research Center</option>
                        <option value="Frem Civic Center">Frem Civic Center</option>
                        <option value="Gilbert and Rose-Marie Chagoury Health Sciences Center">Gilbert and Rose-Marie Chagoury Health Sciences Center</option>
                        <option value="Joseph G. Jabbra Library">Joseph G. Jabbra Library</option>
                        <option value="LAU Health Clinic">LAU Health Clinic</option>
                        <option value="Residence Hall Block B">Residence Hall Block B</option>
                        <option value="Residence Hall Block C">Residence Hall Block C</option>
                        <option value="Riyad Nassar Central Administration">Riyad Nassar Central Administration</option>
                        <option value="Science Building">Science Building</option>
                        <option value="Semaan Melkan Bassil Hall">Semaan Melkan Bassil Hall</option>
                        <option value="Service Center">Service Center</option>
                        <option value="Student Center">Student Center</option>
                        <option value="Tohme-Rizk Hall">Tohme-Rizk Hall</option>
                        <option value="Zakhem Hall">Zakhem Hall</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="officeLevel">Level <span class="required-star">*</span></label>
                    <select id="officeLevel" name="officeLevel" required>
                        <option value="">Select Level...</option>
                        <option value="Basement">Basement</option>
                        <option value="Ground Floor">Ground Floor</option>
                        <option value="1">1st Floor</option>
                        <option value="2">2nd Floor</option>
                        <option value="3">3rd Floor</option>
                        <option value="4">4th Floor</option>
                        <option value="5">5th Floor</option>
                        <option value="6">6th Floor</option>
                        <option value="7">7th Floor</option>
                        <option value="8">8th Floor</option>
                        <option value="9">9th Floor</option>
                        <option value="10">10th Floor</option>
                        <option value="11">11th Floor</option>
                        <option value="12">12th Floor</option>
                        <option value="13">13th Floor</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="officeRoom">Room/Office Number <span class="required-star">*</span></label>
                    <input type="text" id="officeRoom" name="officeRoom" placeholder="e.g., Office 301B, Lab 402" required>
                </div>
                <div>
                    <label for="officeIssueCategory">Issue Category <span class="required-star">*</span></label>
                    <select id="officeIssueCategory" name="officeIssueCategory" required>
                        <option value="">Select Issue Category...</option>
                        <option value="Computer Hardware (PC/Laptop)">Computer Hardware (PC/Laptop)</option>
                        <option value="Software Application">Software Application</option>
                        <option value="Printer/Scanner/Copier">Printer/Scanner/Copier</option>
                        <option value="Network/Internet Connectivity">Network/Internet Connectivity</option>
                        <option value="Telephone/VoIP">Telephone/VoIP</option>
                        <option value="Office Equipment (Non-PC)">Office Equipment (Non-PC, e.g., shredder)</option>
                        <option value="Audiovisual Equipment (Meeting Room)">Audiovisual Equipment (Meeting Room)</option>
                        <option value="Account/Password Issue">Account/Password Issue</option>
                        <option value="Other IT Issue">Other IT Issue</option>
                    </select>
                </div>
                <div>
                    <label for="officeIssueDescription">Description of Issue <span class="required-star">*</span></label>
                    <textarea id="officeIssueDescription" name="officeIssueDescription" rows="6" placeholder="Please provide a detailed description of the problem (minimum 20 characters)..." required></textarea>
                    <p id="wordCountError" class="error-message" style="display: none;">Description must be at least 20 characters.</p>
                </div>
                <div>
                    <label for="remoteAssistanceCheckbox">
                        <input type="checkbox" id="remoteAssistanceCheckbox" name="remoteAssistanceCheckbox">
                        Request Remote Assistance? (Optional)
                    </label>
                </div>
                <div id="anydeskAddressContainer" class="anydesk-container" style="display: none;">
                    <label for="anydeskAddress">AnyDesk Address <span id="anydeskRequiredStar" class="required-star" style="display:none;">*</span></label>
                    <input type="text" id="anydeskAddress" name="anydeskAddress" placeholder="Enter your AnyDesk address">
                </div>
                <button type="submit" id="submitOfficeIssue" disabled>Submit Issue</button>
            </form>
        </div>

        <div id="adminDashboardContainer" class="office-form-container" style="display: none; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                 <h2 id="dashboardTitle" style="margin-bottom: 0;">Dashboard</h2>
                 <button id="exportOfficeLogButton" style="padding: 5px 10px; cursor: pointer; display: none;">Export Activity Log</button>
            </div>
            
            <div class="admin-dashboard-sections">
                <div class="dashboard-section" id="reportedIssuesSection">
                    <h3>Reported</h3>
                    <div class="issues-list" id="reportedIssuesList"></div>
                </div>
                <div class="dashboard-section" id="pendingIssuesSection">
                    <h3>Pending</h3>
                    <div class="issues-list" id="pendingIssuesList"></div>
                </div>
                <div class="dashboard-section" id="completedIssuesSection">
                    <div class="section-header">
                        <h3>Completed</h3>
                        <button id="clearCompletedIssuesButton" class="action-btn clear-all-btn" title="Clear All Completed Issues">Clear All</button>
                    </div>
                    <div class="issues-list" id="completedIssuesList"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="genericAlertModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="genericAlertModalTitle">Alert</h2>
            <p id="genericAlertModalMessage"></p>
            <div class="modal-actions">
                <button id="genericAlertModalOkButton">OK</button>
            </div>
        </div>
    </div>

    <div id="genericConfirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="genericConfirmModalTitle">Confirmation</h2>
            <p id="genericConfirmModalMessage"></p>
            <div class="modal-actions">
                <button id="genericConfirmModalYesButton">Yes</button>
                <button id="genericConfirmModalNoButton">No</button>
            </div>
        </div>
    </div>
    
    <div id="officeExportLogModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="officeExportLogModalCloseButton"><span class="close-x">×</span></span>
            <h2>Export Office Activity Log</h2>
            <p>Select criteria to filter and export the log.</p>

            <div style="margin-top: 10px;">
                <label>Building(s):</label>
                <div id="officeExportBuildingCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 5px;">
                    </div>
            </div>

            <div style="margin-top: 10px;">
                <label>Issue Category(s):</label>
                <div id="officeExportCategoryCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 5px;">
                    </div>
            </div>

            <div style="margin-top: 10px;">
                <label for="officeExportHandledByInput">Actor/User Name:</label>
                <input type="text" id="officeExportHandledByInput" placeholder="Enter name to filter (optional)">
            </div>

            <div style="margin-top: 10px;">
                <label for="officeExportStartDate">Start Date:</label>
                <input type="date" id="officeExportStartDate" required>
                <p id="officeStartDateError" class="error-message" style="color: red; font-size: 0.8em; margin-top: 2px; display: none;">Start Date is required.</p>
            </div>
            <div style="margin-top: 10px;">
                <label for="officeExportEndDate">End Date:</label>
                <input type="date" id="officeExportEndDate" required>
                <p id="officeEndDateError" class="error-message" style="color: red; font-size: 0.8em; margin-top: 2px; display: none;">End Date is required.</p>
            </div>

            <button id="submitOfficeExportLog" style="margin-top: 15px;">Export Log</button>
            <p id="officeExportStatusMessage" style="color: blue; margin-top: 10px; display: none;"></p>
        </div>
    </div>

   <div id="supportHandleIssueModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="supportHandleIssueModalCloseButton"><span class="close-x">×</span></span>
            <div id="supportHandleIssueFormContainer">
                <h2>Handle Issue</h2>
                <form id="supportHandleIssueForm">
                    <div>
                        <label for="supportStaffNameSelect">Issue handled by: <span class="required-star">*</span></label>
                        <select id="supportStaffNameSelect" class="staff-select" required>
                            <option value="">Select staff member...</option>
                            <option>Adel Deek</option>
                            <option>Hadi El Hajj</option>
                            <option>Jimmy Matar</option>
                            <option>Marc El Halaby</option>
                            <option>Marwa Yassine</option>
                            <option>Mohamad Jamal Srouji</option>
                            <option>Nathalie Fayad</option>
                            <option>Rabih Ghantous</option>
                            <option>Wassim Sleem</option>
                            <option value="Other">Other (Specify)</option>
                        </select>
                    </div>
                    <div>
                         <input type="text" id="supportStaffNameOther" name="supportStaffNameOther" placeholder="Enter staff name if 'Other'" style="display:none; margin-top:10px;">
                    </div>
                    <button type="submit" id="submitSupportHandledIssue" disabled>Confirm Handle</button>
                </form>
            </div>
            <div id="supportHandleIssueSuccessMessage" style="display: none; color: green; text-align: center; padding: 20px; font-size: 1.1rem;">
                <p>Issue handled by <strong id="supportSuccessStaffName"></strong>.</p>
            </div>
        </div>
    </div>

    <div id="completionNoteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" id="completionNoteModalCloseButton"><span class="close-x">×</span></span>
            <div id="completionNoteFormContainer">
                <h2>Add Completion Note</h2>
                <form id="completionNoteForm">
                    <div>
                        <label for="completionNoteText">Completion Note (min. 20 characters): <span class="required-star">*</span></label>
                        <textarea id="completionNoteText" name="completionNoteText" rows="5" placeholder="Describe the resolution or steps taken..." required></textarea>
                        <p id="completionNoteError" class="error-message" style="color: red; display: none;">Note must be at least 20 characters.</p>
                    </div>
                    <button type="submit" id="submitCompletionNoteButton" disabled>Submit Completion</button>
                </form>
            </div>
            <div id="completionNoteSuccessMessage" style="display: none; color: green; text-align: center; padding: 20px; font-size: 1.1rem;">
                <p>Issue marked as Completed.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, serverTimestamp, get, update, remove, query, orderByChild, startAt, endAt } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-messaging.js";
        import { firebaseConfig } from './config.js'; 

        // --- Global Variables & Firebase Initialization ---
        let app, database, firebaseTools, currentUserRole;
        let currentHandlingIssueId = null;
        let currentCompletingIssueId = null;
        let allFetchedOfficeIssuesData = null;
        let alertResolve = null, confirmResolve = null;
        const officeSectionId = 'Offices'; // AMENDED: Added a constant for the root path in Firebase.

        try {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                throw new Error("Firebase configuration is missing or incomplete in config.js.");
            }
            app = initializeApp(firebaseConfig);
            getAnalytics(app);
            database = getDatabase(app);
            firebaseTools = { database, ref, set, onValue, push, serverTimestamp, get, update, remove, query, orderByChild, startAt, endAt };
        } catch (error) {
            console.error("❌ Firebase initialization failed:", error);
            alert("A critical error occurred during application initialization. Please check the console.");
        }
        let messaging;
const VAPID_KEY = "BOD99XqIbdfLXNIfPvONwKBa6YRHH4YVRbswAvj8PMVqJRuCVW3RD3XdpPJ4YLyN0DGxSuiuvZuTyvOa5inK76o"; // IMPORTANT: Replace with your actual VAPID key from Firebase Console

// Function to request notification permission and get token
async function requestNotificationPermissionAndGetToken(userRole) {
    if (!('Notification' in window) || !('serviceWorker' in navigator) || !VAPID_KEY) {
        console.warn('Notifications not supported or VAPID key missing.');
        return;
    }
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            messaging = getMessaging(app); // Ensure 'app' is accessible (initialized Firebase app)
            const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
            if (currentToken) {
                console.log('FCM registration token:', currentToken);
                await saveMessagingTokenToDatabase(currentToken, userRole);
            } else {
                console.log('No FCM registration token available. Request permission to generate one.');
            }
        } else {
            console.warn('Notification permission denied or dismissed.');
        }
    } catch (error) {
        console.error('Error getting FCM token:', error);
    }
}

// Function to save the token to Firebase Realtime Database
async function saveMessagingTokenToDatabase(token, userRole) {
    const fcmTokensRef = ref(database, `fcmTokens/<span class="math-inline">\{userRole\}/</span>{token}`);
    try {
        await set(fcmTokensRef, {
            token: token,
            timestamp: serverTimestamp(),
            lastAccessedRole: userRole,
        });
        console.log(`FCM token saved for role: ${userRole}`);
    } catch (error) {
        console.error('Error saving FCM token to database:', error);
    }
}
        // --- DOMContentLoaded: Main Entry Point ---
        document.addEventListener("DOMContentLoaded", function () {
            requestAnimationFrame(() => {
                document.body.style.opacity = '1';
            });

            const pageTitle = document.getElementById('pageTitle');
            const officeFormContainer = document.getElementById('actualOfficeFormContainer');
            const adminDashboardContainer = document.getElementById('adminDashboardContainer');
            const mainContent = document.getElementById('mainContent');
            const dashboardTitle = document.getElementById('dashboardTitle');
            const exportOfficeLogButton = document.getElementById('exportOfficeLogButton');
            
            currentUserRole = sessionStorage.getItem('userRole');

            if (!currentUserRole) {
                alert("Access Denied. Please log in first.");
                window.location.href = 'index.html';
                return;
            }

            console.log(`Access granted with role: ${currentUserRole}`);

            initializeUserForm();
            initializeDashboardModals();

            switch (currentUserRole) {
                case 'user':
                    if (officeFormContainer) officeFormContainer.style.display = 'block';
                    if (adminDashboardContainer) adminDashboardContainer.style.display = 'none';
                    if (pageTitle) pageTitle.textContent = 'Office Support Request';
                    break;
                case 'support':
                    if (officeFormContainer) officeFormContainer.style.display = 'none';
                    if (adminDashboardContainer) adminDashboardContainer.style.display = 'block';
                    if (mainContent) mainContent.classList.add('main-content-admin-active');
                    if (dashboardTitle) dashboardTitle.textContent = 'Support Dashboard';
                    if (exportOfficeLogButton) exportOfficeLogButton.style.display = 'none';
                    loadAndDisplayOfficeIssues('support');
                    break;
                case 'admin':
                    if (officeFormContainer) officeFormContainer.style.display = 'none';
                    if (adminDashboardContainer) adminDashboardContainer.style.display = 'block';
                    if (mainContent) mainContent.classList.add('main-content-admin-active');
                    if (dashboardTitle) dashboardTitle.textContent = 'Admin Dashboard';
                    if (exportOfficeLogButton) exportOfficeLogButton.style.display = 'inline-block';
                    loadAndDisplayOfficeIssues('admin');
                    break;
                default:
                     alert("Unknown role. Redirecting to login.");
                     window.location.href = 'index.html';
            }

            if (currentUserRole) {
        requestNotificationPermissionAndGetToken(currentUserRole);
    }
        });

        // --- Centralized Activity Logging Function ---
        async function logOfficeActivity(issueId, activityType, details = {}) {
            if (!issueId) {
                console.error("FATAL: logOfficeActivity called without a valid issueId.");
                return;
            }
            try {
                // AMENDED: Added officeSectionId to create the path 'Offices/officeActivityLog/...'.
                const logCollectionRef = ref(database, `${officeSectionId}/officeActivityLog/${issueId}`);
                const newLogEntryRef = push(logCollectionRef);

                const logData = {
                    logId: newLogEntryRef.key,
                    timestamp: serverTimestamp(),
                    activityType: activityType,
                    actorRole: currentUserRole || 'N/A',
                    ...details
                };
                await set(newLogEntryRef, logData);
                console.log(`Activity logged for issue ${issueId}: ${activityType}`);
            } catch (error) {
                console.error(`Failed to log office activity for issue ${issueId}:`, error);
            }
        }


        // --- Function Definitions ---

        function initializeUserForm() {
            const form = document.getElementById('officeIssueForm');
            if (!form) return;

            const descriptionTextarea = document.getElementById('officeIssueDescription');
            const remoteCheckbox = document.getElementById('remoteAssistanceCheckbox');
            const anydeskContainer = document.getElementById('anydeskAddressContainer');
            const anydeskInput = document.getElementById('anydeskAddress');

            function checkFormValidity() {
                const isDescriptionValid = descriptionTextarea.value.trim().length >= 20;
                let allRequiredFilled = true;
                form.querySelectorAll('[required]').forEach(el => {
                    if (!el.value.trim()) allRequiredFilled = false;
                });
                form.querySelector('button[type="submit"]').disabled = !(isDescriptionValid && allRequiredFilled);
            }

            form.addEventListener('input', checkFormValidity);
            form.addEventListener('change', checkFormValidity);

            remoteCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    anydeskContainer.style.display = 'block';
                    anydeskInput.setAttribute('required', 'required');
                } else {
                    anydeskContainer.style.display = 'none';
                    anydeskInput.removeAttribute('required');
                    anydeskInput.value = '';
                }
                checkFormValidity();
            });

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                // AMENDED: Added officeSectionId to create the path 'Offices/allOfficeIssues'.
                const newIssueRef = push(ref(database, `${officeSectionId}/allOfficeIssues`));
                const issueData = {
                    userName: document.getElementById('userName').value.trim(),
                    extensionNumber: document.getElementById('extensionNumber').value.trim(),
                    officeBuilding: document.getElementById('officeBuilding').value,
                    officeLevel: document.getElementById('officeLevel').value,
                    officeRoom: document.getElementById('officeRoom').value.trim(),
                    officeIssueCategory: document.getElementById('officeIssueCategory').value,
                    officeIssueDescription: descriptionTextarea.value.trim(),
                    remoteAssistanceRequested: remoteCheckbox.checked,
                    anydeskAddress: remoteCheckbox.checked ? anydeskInput.value.trim() : '',
                    timestamp: serverTimestamp(),
                    status: "Reported",
                    issueId: newIssueRef.key
                };

                try {
                    await set(newIssueRef, issueData);

                    await logOfficeActivity(newIssueRef.key, 'Issue Submitted', {
                        userName: issueData.userName,
                        issueCategory: issueData.officeIssueCategory,
                        details: `New issue reported by ${issueData.userName} in ${issueData.officeBuilding}.`
                    });
                    // --- NEW: Trigger notification for Admins/Support ---
                    const notificationTriggerRef = ref(database, `notificationTriggers/newOfficeIssue`);
                    await push(notificationTriggerRef, {
                        issueId: newIssueRef.key,
                        building: issueData.officeBuilding,
                        room: issueData.officeRoom,
                        category: issueData.officeIssueCategory,
                        reportedBy: issueData.userName,
                        timestamp: serverTimestamp(),
                        targetRoles: ['admin', 'support']
                    });
                    console.log("🔔 Notification trigger sent for new office issue.");
                    // --- END NEW ---
                    await showGenericAlert("Issue submitted successfully", "", { autoClose: true, duration: 2500, showOkButton: false });
                    
                    form.reset();
                    anydeskContainer.style.display = 'none';
                    anydeskInput.removeAttribute('required');
                    submitButton.disabled = true;
                } catch (error) {
                    console.error("Error submitting office issue:", error);
                    await showGenericAlert("Submission Failed", `Failed to submit issue: ${error.message}`);
                    submitButton.disabled = false;
                }
            });
        }


        function initializeDashboardModals() {
            const supportHandleForm = document.getElementById('supportHandleIssueForm');
            const supportStaffSelect = document.getElementById('supportStaffNameSelect');
            const supportStaffOtherInput = document.getElementById('supportStaffNameOther');
            supportStaffSelect?.addEventListener('change', function() {
                const isOther = this.value === 'Other';
                supportStaffOtherInput.style.display = isOther ? 'block' : 'none';
                supportStaffOtherInput.required = isOther;
                validateSupportHandleForm();
            });
            supportStaffOtherInput?.addEventListener('input', validateSupportHandleForm);
            supportHandleForm?.addEventListener('submit', handleSupportFormSubmit);
            document.getElementById('supportHandleIssueModalCloseButton')?.addEventListener('click', closeSupportHandleModal);

            const completionNoteForm = document.getElementById('completionNoteForm');
            const completionNoteText = document.getElementById('completionNoteText');
            completionNoteText?.addEventListener('input', validateCompletionNoteForm);
            completionNoteForm?.addEventListener('submit', handleCompletionNoteSubmit);
            document.getElementById('completionNoteModalCloseButton')?.addEventListener('click', closeCompletionNoteModal);
            
            document.getElementById('exportOfficeLogButton')?.addEventListener('click', openExportModal);
            document.getElementById('submitOfficeExportLog')?.addEventListener('click', handleExportLogSubmit);
            document.getElementById('officeExportLogModalCloseButton')?.addEventListener('click', closeExportModal);

            document.getElementById('clearCompletedIssuesButton')?.addEventListener('click', handleClearAllCompleted);
            
            document.getElementById('genericAlertModalOkButton')?.addEventListener('click', () => closeGenericAlertAndResolve());
            document.getElementById('genericConfirmModalYesButton')?.addEventListener('click', () => closeGenericConfirm(true));
            document.getElementById('genericConfirmModalNoButton')?.addEventListener('click', () => closeGenericConfirm(false));
        }

        function loadAndDisplayOfficeIssues(role) {
            // AMENDED: Added officeSectionId to read from 'Offices/allOfficeIssues'.
            const issuesRef = ref(database, `${officeSectionId}/allOfficeIssues`);
            const reportedList = document.getElementById('reportedIssuesList');
            const pendingList = document.getElementById('pendingIssuesList');
            const completedList = document.getElementById('completedIssuesList');
            const completedSection = document.getElementById('completedIssuesSection');

            if (completedSection) {
                completedSection.style.display = role === 'admin' ? 'block' : 'none';
            }

            onValue(issuesRef, (snapshot) => {
                reportedList.innerHTML = '';
                pendingList.innerHTML = '';
                if(completedList) completedList.innerHTML = '';

                if (!snapshot.exists()) {
                    reportedList.innerHTML = '<p>No reported issues.</p>';
                    return;
                }

                allFetchedOfficeIssuesData = snapshot.val();
                const sortedKeys = Object.keys(allFetchedOfficeIssuesData).sort((a, b) => allFetchedOfficeIssuesData[b].timestamp - allFetchedOfficeIssuesData[a].timestamp);
                
                let reportedCount = 0, pendingCount = 0, completedCount = 0;

                sortedKeys.forEach(key => {
                    const issue = allFetchedOfficeIssuesData[key];
                    const issueId = key;
                    const issueElement = document.createElement('div');
                    issueElement.classList.add('dashboard-issue-item', `status-${(issue.status || 'Reported').toLowerCase()}`);
                    
                    const deleteButtonHTML = role === 'admin' ? `<button class="action-btn delete-btn" data-id="${issueId}" title="Delete Issue">🗑️</button>` : '';
                    const handleBtnDisabled = (issue.status === 'Pending' || issue.status === 'Completed');
                    const completeBtnDisabled = (issue.status === 'Completed' || (role === 'support' && issue.status === 'Reported'));

                     issueElement.innerHTML = `
                        <h4>${issue.officeIssueCategory}</h4>
                        <p><strong>User:</strong> ${issue.userName} (Ext: ${issue.extensionNumber})</p>
                        <p><strong>Location:</strong> ${issue.officeBuilding}, Level ${issue.officeLevel}, Room/Office ${issue.officeRoom}</p>
                        <p><strong>Description:</strong> ${issue.officeIssueDescription}</p>
                        ${issue.remoteAssistanceRequested ? `<p><strong>Remote Request:</strong> Yes (AnyDesk: ${issue.anydeskAddress || 'Not provided'})</p>` : ''}
                        ${(issue.status === 'Pending' || issue.status === 'Completed') && issue.handledBy ? `<p><strong>Handled by:</strong> ${issue.handledBy}</p>` : ''}
                        ${issue.status === 'Completed' && issue.completionNote ? `<p><strong>Completion Note:</strong> ${issue.completionNote}</p>` : ''}
                        <p class="timestamp">Reported: ${new Date(issue.timestamp).toLocaleString()}</p>
                        ${issue.lastHandledTimestamp ? `<p class="timestamp">Handled: ${new Date(issue.lastHandledTimestamp).toLocaleString()}</p>` : ''}
                        ${issue.completedTimestamp ? `<p class="timestamp">Completed: ${new Date(issue.completedTimestamp).toLocaleString()}</p>` : ''}
                        <div class="issue-actions">
                            <button class="action-btn pending-btn" data-id="${issueId}" ${handleBtnDisabled ? 'disabled' : ''}>Handle</button>
                            <button class="action-btn completed-btn" data-id="${issueId}" ${completeBtnDisabled ? 'disabled' : ''}>Set Completed</button>
                            ${deleteButtonHTML}
                        </div>
                    `;

                    if (issue.status === 'Reported') {
                        reportedList.appendChild(issueElement);
                        reportedCount++;
                    } else if (issue.status === 'Pending') {
                        pendingList.appendChild(issueElement);
                        pendingCount++;
                    } else if (issue.status === 'Completed' && role === 'admin') {
                        completedList.appendChild(issueElement);
                        completedCount++;
                    }
                    
                    issueElement.querySelector('.pending-btn')?.addEventListener('click', () => {
                        if (role === 'support' || role === 'admin') {
                            openSupportHandleModal(issueId, issue);
                        }
                    });
                    
                    issueElement.querySelector('.completed-btn')?.addEventListener('click', () => openCompletionNoteModal(issueId, issue));
                    issueElement.querySelector('.delete-btn')?.addEventListener('click', () => deleteIssue(issueId));
                });

                if (reportedCount === 0) reportedList.innerHTML = '<p>No new reported issues.</p>';
                if (pendingCount === 0) pendingList.innerHTML = '<p>No pending issues.</p>';
                if (completedCount === 0 && role === 'admin') completedList.innerHTML = '<p>No completed issues.</p>';
            });
        }
        
        async function updateIssueStatus(issueId, newStatus, staffName = null, completionNote = null) {
            // AMENDED: Added officeSectionId to update issues at 'Offices/allOfficeIssues/...'.
            const issueRef = ref(database, `${officeSectionId}/allOfficeIssues/${issueId}`);
            const updateData = { status: newStatus };
            
            const originalIssueSnapshot = await get(issueRef);
            const originalIssueData = originalIssueSnapshot.val();

            if (newStatus === 'Pending' && staffName) {
                updateData.handledBy = staffName;
                updateData.lastHandledTimestamp = serverTimestamp();
            }
            if (newStatus === 'Completed') {
                updateData.handledBy = originalIssueData.handledBy || staffName;
                updateData.completionNote = completionNote;
                updateData.completedTimestamp = serverTimestamp();
            }

            try {
                await update(issueRef, updateData);
                console.log(`Issue ${issueId} updated to ${newStatus}`);

                const logDetails = {
                    actorName: staffName || (currentUserRole === 'admin' ? 'Admin' : 'Support'),
                    details: `Status changed from '${originalIssueData.status}' to '${newStatus}'.`,
                    newStatus: newStatus
                };
                if (completionNote) {
                    logDetails.completionNote = completionNote;
                }
                await logOfficeActivity(issueId, 'Status Updated', logDetails);

                // --- NEW: Trigger notification for End-User (Issue Status Update) ---
                // You'll need the reporter's FCM token or a way to look it up.
                // For now, we'll signal the backend about this event.
                if (newStatus === 'Pending' || newStatus === 'Completed') {
                    const notificationTriggerRef = ref(database, `notificationTriggers/officeIssueStatusUpdate`);
                    await push(notificationTriggerRef, {
                        issueId: issueId,
                        status: newStatus,
                        reportedBy: originalIssueData?.userName, // Assuming username is stored with the issue
                        category: originalIssueData?.officeIssueCategory,
                        timestamp: serverTimestamp(),
                        // targetUserToken: originalIssueData?.reporterFcmToken // If you stored it
                    });
                    console.log(`🔔 Notification trigger sent for office issue status update to ${newStatus}.`);
                }
                // --- END NEW ---

            } catch(error) {
                console.error("Failed to update issue status:", error);
                await showGenericAlert("Update Error", "Could not update issue status.");
            }
        }
        
        async function handleClearAllCompleted() {
            const completedIssuesKeys = Object.keys(allFetchedOfficeIssuesData || {}).filter(
                key => allFetchedOfficeIssuesData[key].status === 'Completed'
            );
        
            if (completedIssuesKeys.length === 0) {
                await showGenericAlert("Information", "There are no completed issues to clear.");
                return;
            }
        
            const confirmed = await showGenericConfirm(
                "Confirm Clearance",
                `Are you sure you want to clear all ${completedIssuesKeys.length} completed issues from the dashboard? Their activity logs will be preserved.`
            );
        
            if (!confirmed) return;
        
            const updates = {};
            completedIssuesKeys.forEach(key => {
                // AMENDED: Added officeSectionId to build the correct path for deletion.
                updates[`${officeSectionId}/allOfficeIssues/${key}`] = null;
            });
        
            try {
                await update(ref(database), updates);

                await logOfficeActivity('_system_actions_', 'Bulk Issues Cleared', {
                    actorName: 'Admin',
                    count: completedIssuesKeys.length,
                    clearedIssueIds: completedIssuesKeys,
                    details: `Cleared ${completedIssuesKeys.length} completed issues from the dashboard. Logs preserved.`
                });
                
                completedIssuesKeys.forEach(key => {
                    if (allFetchedOfficeIssuesData && allFetchedOfficeIssuesData[key]) {
                        delete allFetchedOfficeIssuesData[key];
                    }
                });
                await showGenericAlert("Success", `${completedIssuesKeys.length} completed issues have been cleared.`, { autoClose: true, duration: 2500, showOkButton: false });
            } catch (error) {
                console.error("Failed to clear completed issues:", error);
                await showGenericAlert("Deletion Error", `Could not clear the completed issues: ${error.message}`);
            }
        }

        async function deleteIssue(issueId) {
            const confirmed = await showGenericConfirm("Confirm Deletion", "Are you sure you want to delete this issue? Its activity log will be preserved for historical records.");
            if (!confirmed) return;

            // AMENDED: Added officeSectionId to delete from the correct path.
            const issueRef = ref(database, `${officeSectionId}/allOfficeIssues/${issueId}`);
            try {
                const snapshot = await get(issueRef);
                if (!snapshot.exists()) {
                    await showGenericAlert("Error", "Could not find the issue to delete.");
                    return;
                }
                const issueData = snapshot.val();

                await remove(issueRef);
                
                await logOfficeActivity('_system_actions_', 'Issue Deleted from Dashboard', {
                    deletedIssueId: issueId,
                    actorName: 'Admin',
                    details: `Deleted issue '${issueData.officeIssueCategory}' (reported by ${issueData.userName}) from the main dashboard. Its log is preserved.`
                });

                await showGenericAlert("Success", "Issue deleted from dashboard. Log preserved.", { autoClose: true, showOkButton: false, duration: 2000 });
            } catch(error) {
                console.error("Failed to delete issue:", error);
                await showGenericAlert("Deletion Error", "Could not delete the issue.");
            }
        }
        
        function openSupportHandleModal(issueId, issueData) {
            currentHandlingIssueId = issueId;
            const modal = document.getElementById('supportHandleIssueModal');
            document.getElementById('supportHandleIssueForm').reset();
            validateSupportHandleForm();
            document.getElementById('supportHandleIssueFormContainer').style.display = 'block';
            document.getElementById('supportHandleIssueSuccessMessage').style.display = 'none';
            modal.style.display = 'flex';
            document.getElementById('mainContent').classList.add('blurred');
        }

        function closeSupportHandleModal() {
            document.getElementById('supportHandleIssueModal').style.display = 'none';
            document.getElementById('mainContent').classList.remove('blurred');
            currentHandlingIssueId = null;
        }

        function validateSupportHandleForm() {
            const select = document.getElementById('supportStaffNameSelect');
            const otherInput = document.getElementById('supportStaffNameOther');
            const submitBtn = document.getElementById('submitSupportHandledIssue');
            const isValid = (select.value && (select.value !== 'Other' || (select.value === 'Other' && otherInput.value.trim())));
            submitBtn.disabled = !isValid;
        }

        async function handleSupportFormSubmit(event) {
            event.preventDefault();
            const staffSelect = document.getElementById('supportStaffNameSelect');
            const otherInput = document.getElementById('supportStaffNameOther');
            let staffName = staffSelect.value === 'Other' ? otherInput.value.trim() : staffSelect.value;
            
            await updateIssueStatus(currentHandlingIssueId, 'Pending', staffName);
            
            document.getElementById('supportSuccessStaffName').textContent = staffName;
            document.getElementById('supportHandleIssueFormContainer').style.display = 'none';
            document.getElementById('supportHandleIssueSuccessMessage').style.display = 'block';
            setTimeout(closeSupportHandleModal, 2500);
        }

        function openCompletionNoteModal(issueId, issueData) {
            currentCompletingIssueId = issueId;
            const modal = document.getElementById('completionNoteModal');
            document.getElementById('completionNoteForm').reset();
            validateCompletionNoteForm();
            document.getElementById('completionNoteFormContainer').style.display = 'block';
            document.getElementById('completionNoteSuccessMessage').style.display = 'none';
            modal.style.display = 'flex';
            document.getElementById('mainContent').classList.add('blurred');
        }

        function closeCompletionNoteModal() {
            document.getElementById('completionNoteModal').style.display = 'none';
            document.getElementById('mainContent').classList.remove('blurred');
            currentCompletingIssueId = null;
        }

        function validateCompletionNoteForm() {
            const textarea = document.getElementById('completionNoteText');
            const submitBtn = document.getElementById('submitCompletionNoteButton');
            submitBtn.disabled = textarea.value.trim().length < 20;
        }
        
        async function handleCompletionNoteSubmit(event) {
            event.preventDefault();
            const note = document.getElementById('completionNoteText').value.trim();
            const issueData = allFetchedOfficeIssuesData[currentCompletingIssueId];
            const staffName = issueData?.handledBy || (currentUserRole === 'admin' ? 'Admin' : 'Support');

            await updateIssueStatus(currentCompletingIssueId, 'Completed', staffName, note);
            
            document.getElementById('completionNoteFormContainer').style.display = 'none';
            document.getElementById('completionNoteSuccessMessage').style.display = 'block';
            setTimeout(closeCompletionNoteModal, 2500);
        }

        function openExportModal() {
            const modal = document.getElementById('officeExportLogModal');
            
            const populateCheckboxes = (selectId, containerId, className, allCheckboxLabel) => {
                const selectElement = document.getElementById(selectId);
                const container = document.getElementById(containerId);
                if (!selectElement || !container) return;

                container.innerHTML = ''; 
                const options = Array.from(selectElement.options).filter(opt => opt.value);

                const allDiv = document.createElement('div');
                allDiv.style.fontWeight = 'bold';
                const allCheckboxId = `export_${selectId}_all`;
                allDiv.innerHTML = `<input type="checkbox" id="${allCheckboxId}" value="all" class="${className}-all"><label for="${allCheckboxId}"> All ${allCheckboxLabel}</label>`;
                container.appendChild(allDiv);

                options.forEach(option => {
                    const div = document.createElement('div');
                    const checkboxId = `export_${selectId}_${option.value.replace(/[^a-zA-Z0-9_]/g, '_')}`;
                    div.innerHTML = `<input type="checkbox" id="${checkboxId}" value="${option.value}" class="${className}"><label for="${checkboxId}"> ${option.text}</label>`;
                    container.appendChild(div);
                });

                const allCheckbox = document.getElementById(allCheckboxId);
                const individualCheckboxes = container.querySelectorAll(`.${className}`);
                allCheckbox?.addEventListener('change', function() {
                    individualCheckboxes.forEach(cb => cb.checked = this.checked);
                });
                individualCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (!this.checked) {
                            if (allCheckbox) allCheckbox.checked = false;
                        } else {
                            const allAreChecked = Array.from(individualCheckboxes).every(iCb => iCb.checked);
                            if (allCheckbox) allCheckbox.checked = allAreChecked;
                        }
                    });
                });
            };

            populateCheckboxes('officeBuilding', 'officeExportBuildingCheckboxes', 'office-bldg-cb', 'Buildings');
            populateCheckboxes('officeIssueCategory', 'officeExportCategoryCheckboxes', 'office-cat-cb', 'Categories');
            
            document.getElementById('officeExportStatusMessage').style.display = 'none';
            document.getElementById('officeExportHandledByInput').value = '';
            document.getElementById('officeExportStartDate').value = '';
            document.getElementById('officeExportEndDate').value = '';
            document.getElementById('submitOfficeExportLog').disabled = false;
            
            modal.style.display = 'flex';
            document.getElementById('mainContent').classList.add('blurred');
        }

        function closeExportModal() {
            document.getElementById('officeExportLogModal').style.display = 'none';
            document.getElementById('mainContent').classList.remove('blurred');
        }
        
        async function handleExportLogSubmit(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submitOfficeExportLog');
            submitButton.disabled = true;

            const actorNameFilter = document.getElementById('officeExportHandledByInput').value.trim().toLowerCase();
            const startDateValue = document.getElementById('officeExportStartDate').value;
            const endDateValue = document.getElementById('officeExportEndDate').value;
            const statusMessage = document.getElementById('officeExportStatusMessage');

            const allBuildingsChecked = document.getElementById('export_officeBuilding_all')?.checked;
            let selectedBuildings = [];
            if (allBuildingsChecked || document.querySelectorAll('.office-bldg-cb:checked').length === 0) {
                selectedBuildings = Array.from(document.getElementById('officeBuilding').options).map(opt => opt.value).filter(Boolean);
            } else {
                selectedBuildings = Array.from(document.querySelectorAll('.office-bldg-cb:checked')).map(cb => cb.value);
            }

            const allCategoriesChecked = document.getElementById('export_officeIssueCategory_all')?.checked;
            let selectedCategories = [];
            if (allCategoriesChecked || document.querySelectorAll('.office-cat-cb:checked').length === 0) {
                selectedCategories = Array.from(document.getElementById('officeIssueCategory').options).map(opt => opt.value).filter(Boolean);
            } else {
                selectedCategories = Array.from(document.querySelectorAll('.office-cat-cb:checked')).map(cb => cb.value);
            }

            if (!startDateValue || !endDateValue) {
                await showGenericAlert("Input Required", "Start and End dates are required for export.");
                submitButton.disabled = false;
                return;
            }
            const startTimestamp = new Date(startDateValue + "T00:00:00").getTime();
            const endTimestamp = new Date(endDateValue + "T23:59:59.999").getTime();
            if (startTimestamp > endTimestamp) {
                await showGenericAlert("Input Error", "Start Date cannot be after End Date.");
                submitButton.disabled = false;
                return;
            }

            statusMessage.textContent = "Fetching and processing activity log...";
            statusMessage.style.color = 'blue';
            statusMessage.style.display = 'block';

            try {
                // AMENDED: Added officeSectionId to fetch logs from 'Offices/officeActivityLog'.
                const logRootRef = ref(database, `${officeSectionId}/officeActivityLog`);
                const logSnapshot = await get(logRootRef);

                if (!logSnapshot.exists()) {
                    statusMessage.textContent = "No activity log data found.";
                    statusMessage.style.color = 'orange';
                    submitButton.disabled = false;
                    return;
                }

                const allLogsData = logSnapshot.val();
                if (!allFetchedOfficeIssuesData) {
                    await showGenericAlert("Data Error", "Could not retrieve parent issue data. Please refresh the page.");
                    submitButton.disabled = false;
                    return;
                }
                
                const logArrayForExport = [];
                for (const issueId in allLogsData) {
                    const issueData = allFetchedOfficeIssuesData[issueId];
                    if (!issueData) continue;
                    
                    const buildingMatch = selectedBuildings.includes(issueData.officeBuilding);
                    const categoryMatch = selectedCategories.includes(issueData.officeIssueCategory);

                    if (!buildingMatch || !categoryMatch) continue;

                    const issueLogs = allLogsData[issueId];
                    for (const logId in issueLogs) {
                        const logData = issueLogs[logId];
                        if (logData.timestamp < startTimestamp || logData.timestamp > endTimestamp) continue;

                        let actorMatch = !actorNameFilter;
                        if (actorNameFilter) {
                            const actorChecks = [logData.actorName, logData.userName, issueData.userName];
                            if (actorChecks.some(name => name && name.toLowerCase().includes(actorNameFilter))) {
                                actorMatch = true;
                            }
                        }

                        if (!actorMatch) continue;
                        
                        const formattedLog = {
                            "Issue ID": issueId,
                            "Building": issueData.officeBuilding || 'N/A',
                            "Level": issueData.officeLevel || 'N/A',
                            "Room/Office": issueData.officeRoom || 'N/A',
                            "Issue Category": issueData.officeIssueCategory || 'N/A',
                            "Reported By": issueData.userName || 'N/A',
                            "Reported At": new Date(issueData.timestamp).toISOString(),
                            "Log ID": logData.logId,
                            "Log Timestamp": new Date(logData.timestamp).toISOString(),
                            "Log Activity Type": logData.activityType,
                            "Log New Status": logData.newStatus || '',
                            "Log Actor": logData.actorName || logData.userName || 'N/A',
                            "Log Details": logData.details || 'N/A',
                            "Completion Note": logData.completionNote || ''
                        };
                        logArrayForExport.push(formattedLog);
                    }
                }
                
                if (logArrayForExport.length === 0) {
                    statusMessage.textContent = "No log entries found matching all your criteria.";
                    statusMessage.style.color = 'orange';
                    submitButton.disabled = false;
                    return;
                }

                logArrayForExport.sort((a, b) => new Date(a["Log Timestamp"]) - new Date(b["Log Timestamp"]));

                const worksheet = XLSX.utils.json_to_sheet(logArrayForExport);

                const headerStyle = {
                    font: { name: "Arial", sz: 12, bold: true, color: { rgb: "FFFFFFFF" } },
                    fill: { fgColor: { rgb: "FF016751" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
                const submittedStyle = {
                    font: { color: { rgb: "FF9C0006" } },
                    fill: { fgColor: { rgb: "FFFFC7CE" } }
                };
                const pendingStyle = {
                    font: { color: { rgb: "FF9C6500" } },
                    fill: { fgColor: { rgb: "FFFFEB9C" } }
                };
                const completedStyle = {
                    font: { color: { rgb: "FF006100" } },
                    fill: { fgColor: { rgb: "FFC6EFCE" } }
                };
                const defaultCellStyle = {
                    font: { name: "Arial", sz: 11, color: { rgb: "FF000000" } }
                };

                const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
                for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!worksheet[address]) continue;
                    worksheet[address].s = headerStyle;
                }

                logArrayForExport.forEach((logEntry, index) => {
                    const rowIndex = index + 1;
                    const activityType = logEntry["Log Activity Type"];
                    const newStatus = logEntry["Log New Status"];
                    let rowStyle;
                    if (activityType === "Issue Submitted") {
                        rowStyle = submittedStyle;
                    } else if (activityType === "Status Updated") {
                        if (newStatus === 'Pending') {
                            rowStyle = pendingStyle;
                        } else if (newStatus === 'Completed') {
                            rowStyle = completedStyle;
                        } else {
                            rowStyle = defaultCellStyle;
                        }
                    } else {
                        rowStyle = defaultCellStyle;
                    }
                    for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({ r: rowIndex, c: C });
                        if (!worksheet[address]) continue;
                        if (!worksheet[address].s) {
                            worksheet[address].s = {};
                        }
                        Object.assign(worksheet[address].s, rowStyle);
                    }
                });
                
                const objectMaxLength = [];
                logArrayForExport.forEach(obj => {
                    Object.entries(obj).forEach(([key, value], index) => {
                        const valLength = value ? String(value).length : 0;
                        const keyLength = key ? String(key).length : 0;
                        objectMaxLength[index] = Math.max(objectMaxLength[index] || 0, valLength, keyLength);
                    });
                });
                worksheet['!cols'] = objectMaxLength.map(w => ({ wch: w + 2 }));
                
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Office Activity Log');

                const filename = `office_activity_log_${startDateValue}_to_${endDateValue}.xlsx`;
                XLSX.writeFile(workbook, filename);
                
                statusMessage.textContent = `Export successful! ${logArrayForExport.length} log entries downloaded.`;
                statusMessage.style.color = 'green';
                setTimeout(() => {
                    closeExportModal();
                }, 3000);

            } catch (error) {
                console.error("Error exporting office log:", error);
                statusMessage.textContent = `An error occurred during export: ${error.message}`;
                statusMessage.style.color = 'red';
            } finally {
                submitButton.disabled = false;
            }
        }

        function showGenericAlert(title, message, options = {}) {
            return new Promise(resolve => {
                alertResolve = resolve;
                const modal = document.getElementById('genericAlertModal');
                const modalContent = modal.querySelector('.modal-content');
                document.getElementById('genericAlertModalTitle').textContent = title;
                
                const messageP = document.getElementById('genericAlertModalMessage');
                messageP.textContent = message;
                messageP.style.display = message ? 'block' : 'none';

                modal.style.display = 'flex';
                document.getElementById('mainContent').classList.add('blurred');
                
                const okButton = document.getElementById('genericAlertModalOkButton');

                if (options.autoClose && !message) {
                    modalContent.classList.add('center-content');
                } else {
                    modalContent.classList.remove('center-content');
                }

                if (options.autoClose) {
                    okButton.style.display = 'none';
                    setTimeout(() => closeGenericAlertAndResolve(), options.duration || 2000);
                } else {
                    okButton.style.display = 'inline-block';
                }
            });
        }
        
        function closeGenericAlertAndResolve() {
            const modal = document.getElementById('genericAlertModal');
            const modalContent = modal.querySelector('.modal-content');
            modal.style.display = 'none';
            document.getElementById('mainContent').classList.remove('blurred');
            
            modalContent.classList.remove('center-content');

            if (alertResolve) {
                alertResolve();
                alertResolve = null;
            }
        }
        
        function showGenericConfirm(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const modal = document.getElementById('genericConfirmModal');
                document.getElementById('genericConfirmModalTitle').textContent = title;
                document.getElementById('genericConfirmModalMessage').textContent = message;
                modal.style.display = 'flex';
                document.getElementById('mainContent').classList.add('blurred');
            });
        }
        
        function closeGenericConfirm(value) {
            document.getElementById('genericConfirmModal').style.display = 'none';
            document.getElementById('mainContent').classList.remove('blurred');
            if (confirmResolve) {
                confirmResolve(value);
                confirmResolve = null;
            }
        }

    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((error) => {
            console.error('Service Worker registration failed:', error);
            });
        });
    }
</script>

</body>
</html>
