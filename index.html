<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#016751">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAU Support System</title>
    <link rel="icon" href="pics/lau_icon.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body class="selection-page-body">

    <div id="splashScreen">
        <img src="pics/lau_logo_entry.png" alt="LAU Logo" id="splashLogo">
    </div>
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2>Enter Access Code</h2>
            <input type="password" id="authCode" placeholder="Enter code">
            <button id="submitAuth">Submit</button>
            <p id="error-message" style="color: red; display: none;">Incorrect code, try again.</p>
        </div>
    </div>
    <header>
        <img src="pics/lau_logo.png" alt="University Logo" class="logo" width="150" height="60">
        <h1>LAU Support System</h1>
    </header>

    <main id="mainContent" class="selection-container">
        <div class="intro-text">
            <p>Welcome to LAU Support System. Select the relevant location for your issue and submit your request so our team can help you soon.</p>
        </div>
        <div class="button-group">
            <a href="beirut_classrooms.html" class="selection-button">Beirut Classrooms</a>
            <a href="byblos_classrooms.html" class="selection-button">Byblos Classrooms</a>
        </div>
        <div class="separator-line"></div> <div class="button-group">
            <a href="offices.html" class="selection-button">Offices</a>
        </div>
        <div class="intro-text" style="margin-top: 30px;">
        <h3 style="margin-bottom: 10px;">Contact Us</h3>
        <p style="line-height: 1.6;">
            For immediate assistance, please reach out to our IT Support team:<br>
            <strong>Email:</strong> <a href="mailto:it.support@lau.edu.lb" style="color: #016751;">helpdesk@lau.edu.lb</a><br>
            <strong>Helpdesk Ext:</strong> 1000
        </p>
    </main>

    <script type="module">
    // Import necessary Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-messaging.js";
    import { firebaseConfig } from './config.js';

    try {
        // --- 1. INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        console.log("🔥 Firebase initialized successfully in index.html.");

        // --- 2. GET DOM ELEMENTS ---
        const authModal = document.getElementById('authModal');
        const mainContent = document.getElementById('mainContent');
        const authCodeInput = document.getElementById('authCode');
        const submitAuthButton = document.getElementById('submitAuth');
        const errorMessage = document.getElementById('error-message');

        // --- 3. GLOBAL AUTH STATE ---
        let authCodes = {
            admin: null,
            support: null,
            user: null
        };

        // --- 4. AUTHENTICATION LOGIC ---

        /**
         * Fetches all three authentication codes from Firebase upon page load.
         * This ensures the application is ready to validate user input immediately.
         */
        async function fetchAuthCodes() {
            // Ensure the database URL from your config does not have a trailing slash
            const dbURL = firebaseConfig.databaseURL.replace(/\/$/, '');
            const paths = {
                admin: `${dbURL}/adminAuthCode.json`,
                support: `${dbURL}/supportAuthCode.json`,
                user: `${dbURL}/endUserAuthCode.json` // Standard user code
            };

            try {
                // Fetch all codes in parallel for efficiency
                const [adminRes, supportRes, userRes] = await Promise.all([
                    fetch(paths.admin),
                    fetch(paths.support),
                    fetch(paths.user)
                ]);

                // Check if all network requests were successful
                if (!adminRes.ok || !supportRes.ok || !userRes.ok) {
                    throw new Error("One or more authentication code network responses were not ok.");
                }

                // Parse the JSON from the responses
                authCodes.admin = await adminRes.json();
                authCodes.support = await supportRes.json();
                authCodes.user = await userRes.json();

                console.log("✅ Authentication codes loaded successfully.");
                
                // Enable the form now that authentication codes are loaded.
                authCodeInput.disabled = false;
                submitAuthButton.disabled = false;
                authCodeInput.placeholder = "Enter code"; // Restore placeholder text

            } catch (error) {
                console.error("❌ Failed to load authentication codes:", error);
                errorMessage.textContent = "Could not load authentication configuration. Please refresh.";
                errorMessage.style.display = 'block';
                // Keep the form disabled if codes fail to load
                authCodeInput.placeholder = "Error loading...";
            }
        }

        /**
         * Checks the entered code against the fetched auth codes and grants access.
         * AMENDED: Now redirects to the specific classroom page if parameters are present.
         */
        function checkAuth() {
            const enteredCode = authCodeInput.value.trim();
            let userRole = null;

            // Determine user role based on the entered code
            if (enteredCode === authCodes.admin) {
                userRole = 'admin';
            } else if (enteredCode === authCodes.support) {
                userRole = 'support';
            } else if (enteredCode === authCodes.user) {
                userRole = 'user';
            }

            if (userRole) {
                // On successful authentication
                console.log(`Authentication successful. Role assigned: ${userRole}`);
                sessionStorage.setItem('userRole', userRole);
                authModal.style.display = 'none';
                mainContent.classList.remove("blurred");
                errorMessage.style.display = 'none';

                // --- NEW REDIRECTION LOGIC ---
                const urlParams = new URLSearchParams(window.location.search);
                const buildingParam = urlParams.get('building');
                const levelParam = urlParams.get('level');
                const roomParam = urlParams.get('room');
                const modeParam = urlParams.get('mode');
                const fromBatchParam = urlParams.get('fromBatch');

                // Check if we have classroom-specific parameters from the batch file
                if (buildingParam && levelParam && roomParam && modeParam === 'single' && fromBatchParam === 'true') {
                    let classroomPage = '';
                    // Determine the correct classroom HTML file based on the building
                    const beirutBuildings = ["AKSOB", "Fine Arts", "Gezairi", "Nicol Hall", "Sage Hall", "WKSC"];
                    const byblosBuildings = ["Block A", "Library", "Science", "Architecture", "Engineering", "Frem", "CHSC", "ELRC"];

                    if (beirutBuildings.includes(buildingParam)) {
                        classroomPage = 'beirut_classrooms.html';
                    } else if (byblosBuildings.includes(buildingParam)) {
                        classroomPage = 'byblos_classrooms.html';
                    }

                    if (classroomPage) {
                        // Reconstruct the URL with all parameters for the classroom page
                        const redirectUrl = `${classroomPage}?${urlParams.toString()}`;
                        console.log(`Redirecting to specific classroom: ${redirectUrl}`);
                        window.location.href = redirectUrl;
                        return; // Stop further execution
                    } else {
                        console.warn(`Building '${buildingParam}' not recognized for specific classroom redirect. Proceeding to campus selection.`);
                    }
                }
                
                // If no specific classroom parameters or building not recognized, proceed to campus selection page
                console.log("No specific classroom parameters found or building unrecognized. Showing campus selection.");
                // The modal is already hidden, main content already unblurred, just let the user interact with buttons
            } else {
                // On failed authentication
                console.warn("Authentication failed: Incorrect code entered.");
                errorMessage.style.display = 'block';
                authCodeInput.value = ''; // Clear the incorrect input
                authCodeInput.focus(); // Set focus back to the input field
            }
        }

        // --- 5. ADD EVENT LISTENERS AND RUN ON PAGE LOAD ---
        document.addEventListener("DOMContentLoaded", () => {
            const splashScreen = document.getElementById('splashScreen');
            
            mainContent.classList.add("blurred");
            sessionStorage.removeItem('userRole'); // Clear any previous role

            // Disable controls on load to prevent interaction before codes are fetched
            authCodeInput.disabled = true;
            submitAuthButton.disabled = true;

            // Immediately check for role in sessionStorage. If found, and relevant URL params exist,
            // directly redirect to avoid showing index.html at all, improving user experience.
            const userRoleInSession = sessionStorage.getItem('userRole');
            const urlParamsOnLoad = new URLSearchParams(window.location.search);
            const buildingParamOnLoad = urlParamsOnLoad.get('building');
            const modeParamOnLoad = urlParamsOnLoad.get('mode');

            if (userRoleInSession && buildingParamOnLoad && modeParamOnLoad === 'single') {
                 let directClassroomPage = '';
                 const beirutBuildings = ["AKSOB", "Fine Arts", "Gezairi", "Nicol Hall", "Sage Hall", "WKSC"];
                 const byblosBuildings = ["Block A", "Library", "Science", "Architecture", "Engineering", "Frem", "CHSC", "ELRC"];

                 if (beirutBuildings.includes(buildingParamOnLoad)) {
                     directClassroomPage = 'beirut_classrooms.html';
                 } else if (byblosBuildings.includes(buildingParamOnLoad)) {
                     directClassroomPage = 'byblos_classrooms.html';
                 }

                 if (directClassroomPage) {
                     console.log("User already authenticated and specific classroom URL found. Directing without splash/auth modal.");
                     window.location.href = `${directClassroomPage}?${urlParamsOnLoad.toString()}`;
                     return; // Crucial: Stop execution here to prevent showing splash/auth
                 }
            }


            // Normal flow: Show splash, then auth modal, then fetch codes
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                splashScreen.addEventListener('transitionend', () => {
                    splashScreen.style.display = 'none';
                    authModal.style.display = 'flex'; // Show auth modal
                    authCodeInput.focus();
                    fetchAuthCodes(); // Fetch codes after splash screen animation
                }, { once: true });
            }, 2500); // Duration of splash screen display

            // Add the event listeners that call the now-defined checkAuth function
            submitAuthButton.addEventListener('click', checkAuth);
            authCodeInput.addEventListener('keypress', (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    if (!submitAuthButton.disabled) {
                        checkAuth();
                    }
                }
            });

            requestAnimationFrame(() => {
                document.body.style.opacity = '1';
            });
        });

    } catch (error) {
        console.error("❌ A critical error occurred during initialization:", error);
        alert("A critical error occurred. The application cannot start.");
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.innerHTML = "<p style='color:red; text-align:center;'>Application could not start due to a configuration error.</p>";
            mainContent.classList.remove("blurred");
        }
    }

    // --- FCM Related Functions ---
let messaging;
const VAPID_KEY = "YOUR_VAPID_KEY_HERE"; // IMPORTANT: Replace with your actual VAPID key from Firebase Console

// Function to request notification permission and get token
async function requestNotificationPermissionAndGetToken(userRole) {
    if (!('Notification' in window) || !('serviceWorker' in navigator) || !VAPID_KEY) {
        console.warn('Notifications not supported or VAPID key missing.');
        return;
    }

    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            messaging = getMessaging(app); // Initialize messaging with your Firebase app
            const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
            if (currentToken) {
                console.log('FCM registration token:', currentToken);
                // Send this token to your Firebase Realtime Database
                // Associate it with the current user's role and a unique identifier (e.g., userId or a generated UUID)
                await saveMessagingTokenToDatabase(currentToken, userRole);
            } else {
                console.log('No FCM registration token available. Request permission to generate one.');
            }
        } else {
            console.warn('Notification permission denied or dismissed.');
        }
    } catch (error) {
        console.error('Error getting FCM token:', error);
    }
}

// Function to save the token to Firebase Realtime Database
async function saveMessagingTokenToDatabase(token, userRole) {
    // You should structure this path based on your Firebase database rules.
    // For example: /fcmTokens/<userRole>/<token>
    // Or if you have user authentication, /users/<userId>/fcmTokens/<token>
    // For this example, let's assume a simplified structure where we overwrite for each user role
    const fcmTokensRef = ref(database, `fcmTokens/${userRole}/${token}`);
    try {
        await set(fcmTokensRef, {
            token: token,
            timestamp: serverTimestamp(),
            lastAccessedRole: userRole,
            // You might want to add more user-specific data here, like a user ID from your auth system
        });
        console.log(`FCM token saved for role: ${userRole}`);
    } catch (error) {
        console.error('Error saving FCM token to database:', error);
    }
}

// --- Modify checkAuth function to request notification permission after successful login ---
function checkAuth() {
    const enteredCode = authCodeInput.value.trim();
    let userRole = null;

    // Determine user role based on the entered code
    if (enteredCode === authCodes.admin) {
        userRole = 'admin';
    } else if (enteredCode === authCodes.support) {
        userRole = 'support';
    } else if (enteredCode === authCodes.user) {
        userRole = 'user';
    }

    if (userRole) {
        console.log(`Authentication successful. Role assigned: ${userRole}`);
        sessionStorage.setItem('userRole', userRole);
        authModal.style.display = 'none';
        mainContent.classList.remove("blurred");
        errorMessage.style.display = 'none';

        // Request notification permission and get token AFTER successful login
        requestNotificationPermissionAndGetToken(userRole);

    } else {
        console.warn("Authentication failed: Incorrect code entered.");
        errorMessage.style.display = 'block';
        authCodeInput.value = '';
        authCodeInput.focus();
    }
}
</script>

    <script>
        function officeButtonClicked() {
            alert("Offices section coming soon!");
        }

        document.addEventListener("DOMContentLoaded", function () {
            requestAnimationFrame(() => {
                document.body.style.opacity = '1';
            });
        });
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((error) => {
            console.error('Service Worker registration failed:', error);
            });
        });
    }
</script>
</body>
</html>