<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#016751">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAU Support System</title>
    <link rel="icon" href="pics/lau_icon.png" type="image/x-icon">
    <link rel="stylesheet" href="style.css">

   <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>

</head>

<body>
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-button"><span class="close-x">√ó</span></span>
            <h2>Enter access code</h2>
            <input type="password" id="authCode" placeholder="Enter code">
            <button onclick="checkAuth()">Submit</button>
            <p id="error-message" style="color: red; display: none;">Incorrect code, try again.</p>
        </div>
    </div>

    <!--<div id="exportAuthModal" class="modal export-auth-modal" style="display: none;">
        <div class="modal-content">
             <span class="close-button"><span class="close-x">√ó</span></span>
            <h2>Export Access Required</h2>
            <p>Please enter the access code to export logs.</p>
            <input type="password" id="exportAuthCode" placeholder="Enter code">
            <button onclick="checkExportAuth()">Submit</button>
            <p id="export-error-message" style="color: red; display: none;">Incorrect code, try again.</p>
        </div>
    </div>-->

    <div id="issueModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button"><span class="close-x">√ó</span></span>
            <h2>Report issue for <span id="classroomName"></span></h2>
            <div class="issue-buttons">
                <button class="issue-btn" data-issue="PC">PC</button>
                <button class="issue-btn" data-issue="Screen">Screen</button>
                <button class="issue-btn" data-issue="Projector">Projector</button>
                <button class="issue-btn" data-issue="Sound">Sound</button>
                <button class="issue-btn" data-issue="Panel">Panel</button>
            </div>
            <input type="text" id="customIssue" placeholder="Other issue (describe briefly)">
            <textarea id="issueDetails" placeholder="Detailed description of the issue..."></textarea>
            <button id="submitIssue" disabled>Report Issue</button>
            <div id="successMessage" style="display: none; color: green; text-align: center; padding: 10px;">
                Issue reported successfully
            </div>
        </div>
    </div>

    <div id="handleIssueModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button"><span class="close-x">√ó</span></span>
            <div id="handleIssueForm">
                <h2><span id="handledClassroomName"></span></h2>
                <label for="staffNameSelect">Issue handled by:</label>
                <select id="staffNameSelect" class="staff-select">
                    <option value="">Select staff member</option>
                    <option>Adel Deek</option>
                    <option>Hadi El Hajj</option>
                    <option>Jimmy Matar</option>
                    <option>Marc El Halaby</option>
                    <option>Marwa Yassine</option>
                    <option>Mohamad Jamal Srouji</option>
                    <option>Nathalie Fayad</option>
                    <option>Rabih Ghantous</option>
                    <option>Wassim Sleem</option>
                </select>
                <button id="submitHandledIssue" disabled>Submit</button> </div>
            <div id="handleIssueSuccessMessage" style="display: none;">
                </div>
        </div>
    </div>

    <div id="cancelConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <div style="white-space: nowrap; margin-bottom: 15px; font-weight: bold; font-size: 20px">Are you sure you want to cancel?</div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="handleCancelConfirmation(true)" style="background-color: #ff4444; margin-right: 0;">Yes</button>
                <button onclick="handleCancelConfirmation(false)">No</button>
            </div>
        </div>
    </div>

    <div id="exportLogModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button"><span class="close-x">√ó</span></span>
            <h2>Export Activity Log</h2>
            <p>Select criteria to filter and export the log.</p>

            <div style="margin-top: 10px;">
                <label>Building Name(s):</label>
                <div id="exportBuildingCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 5px;">
                    </div>
            </div>

            <div style="margin-top: 10px;">
                <label>Classroom Selection:</label>
                <div id="exportClassroomModeSelection" style="padding: 5px; margin-top: 5px;">
                    <div>
                        <input type="radio" id="exportClassroomModeAll" name="classroomExportMode" value="all" checked>
                        <label for="exportClassroomModeAll"> All Classrooms (within selected buildings)</label>
                    </div>
                    <div>
                        <input type="radio" id="exportClassroomModeChoose" name="classroomExportMode" value="choose">
                        <label for="exportClassroomModeChoose"> Choose Specific Classroom(s)...</label>
                    </div>
                </div>
            </div>

            <div id="exportSpecificClassroomSelection" style="margin-top: 10px; display: none;">
                <label>Choose Classroom(s):</label>
                <div id="exportClassroomCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin-top: 5px;">
                     </div>
           </div>

            <div style="margin-top: 10px;">
                <label for="exportHandledByInput">Handled by:</label>
                <input type="text" id="exportHandledByInput" placeholder="Enter staff name to filter (optional)">
            </div>

            <div style="margin-top: 10px;">
                <label for="exportStartDate">Start Date:</label>
                <input type="date" id="exportStartDate">
                <p id="startDateError" class="error-message" style="color: red; font-size: 0.8em; margin-top: 2px; display: none;">Start Date is required.</p>
            </div>

            <div style="margin-top: 10px;">
                <label for="exportEndDate">End Date:</label>
                <input type="date" id="exportEndDate">
                 <p id="endDateError" class="error-message" style="color: red; font-size: 0.8em; margin-top: 2px; display: none;">End Date is required.</p>
            </div>

            <button id="submitExportLog" style="margin-top: 15px;">Export Log</button>
            <p id="exportStatusMessage" style="color: blue; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <audio id="peepSound" src="sound/beep_warning.mp3" preload="auto"></audio>

    <header>
        <a href="index.html" class="back-button" aria-label="Go back to homepage">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="back-arrow-icon">
                <path fill-rule="evenodd" d="M15.707 5.293a1 1 0 010 1.414L10.414 12l5.293 5.293a1 1 0 01-1.414 1.414l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
        </a> 
        <img src="pics/lau_logo.png" alt="University Logo" class="logo" width="150" height="60">
        <h1>Beirut Classrooms</h1>
        <div class="header-controls"> <button id="muteButton" class="mute-button">üîä</button>
        </div>
    </header>
        <div class="main-controls">
            <button id="exportLogButton" style="display: none;">Export Activity Log</button>
        </div>
    <main id="mainContent" class="campus-container">
        <section class="building-container">
            <h2>WKSC</h2>
            <div class="level-container">
                <div class="level-title">Level 2</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">201</div>
                    <div class="classroom" data-tap="0">204</div>
                    <div class="classroom" data-tap="0">205</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>

        <section class="building-container">
            <h2>Sage Hall</h2>
            <div class="level-container">
                <div class="level-title">Level 2</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">203</div>
                    <div class="classroom" data-tap="0">204</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 3</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">301</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>

        <section class="building-container">
            <h2>Fine Arts</h2>
            <div class="level-container">
                <div class="level-title">Level 1</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">109</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 2</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">204</div>
                    <div class="classroom" data-tap="0">205</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 6</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">601</div>
                    <div class="classroom" data-tap="0">602</div>
                    <div class="classroom" data-tap="0">603</div>
                    <div class="classroom" data-tap="0">605</div>
                    <div class="classroom" data-tap="0">606</div>
                    <div class="classroom" data-tap="0">607</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>

        <section class="building-container">
            <h2>Nicol Hall</h2>
            <div class="level-container">
                <div class="level-title">Level 2</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">215</div>
                    <div class="classroom" data-tap="0">216</div>
                    <div class="classroom" data-tap="0">217</div>
                    <div class="classroom" data-tap="0">218</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 3</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">304</div>
                    <div class="classroom" data-tap="0">305</div>
                    <div class="classroom" data-tap="0">306</div>
                    <div class="classroom" data-tap="0">307</div>
                    <div class="classroom" data-tap="0">312</div>
                    <div class="classroom" data-tap="0">313</div>
                    <div class="classroom" data-tap="0">318</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 4</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">403</div>
                    <div class="classroom" data-tap="0">404</div>
                    <div class="classroom" data-tap="0">407</div>
                    <div class="classroom" data-tap="0">408</div>
                    <div class="classroom" data-tap="0">409</div>
                    <div class="classroom" data-tap="0">417</div>
                    <div class="classroom" data-tap="0">418</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 5</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">502</div>
                    <div class="classroom" data-tap="0">503</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>

        <section class="building-container">
            <h2>AKSOB</h2>
            <div class="level-container">
                <div class="level-title">Level 9</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">903</div>
                    <div class="classroom" data-tap="0">904</div>
                    <div class="classroom" data-tap="0">905</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 10</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1003</div>
                    <div class="classroom" data-tap="0">1004</div>
                    <div class="classroom" data-tap="0">1005</div>
                    <div class="classroom" data-tap="0">1006</div>
                    <div class="classroom" data-tap="0">1007</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 11</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1107</div>
                    <div class="classroom" data-tap="0">1108</div>
                    <div class="classroom" data-tap="0">1109</div>
                    <div class="classroom" data-tap="0">1110</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 12</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1207</div>
                    <div class="classroom" data-tap="0">1208</div>
                    <div class="classroom" data-tap="0">1209</div>
                    <div class="classroom" data-tap="0">1210</div>
                    <div class="classroom" data-tap="0">1211</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 13</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1307</div>
                    <div class="classroom" data-tap="0">1308</div>
                    <div class="classroom" data-tap="0">1309</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>

        <section class="building-container">
            <h2>Gezairi</h2>
            <div class="level-container">
                <div class="level-title">Level 4</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">403</div>
                    <div class="classroom" data-tap="0">404</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 8</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">801</div>
                    <div class="classroom" data-tap="0">802</div>
                    <div class="classroom" data-tap="0">803</div>
                    <div class="classroom" data-tap="0">804</div>
                    <div class="classroom" data-tap="0">805</div>
                    <div class="classroom" data-tap="0">808</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 9</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">901</div>
                    <div class="classroom" data-tap="0">902</div>
                    <div class="classroom" data-tap="0">903</div>
                    <div class="classroom" data-tap="0">905</div>
                    <div class="classroom" data-tap="0">906</div>
                    <div class="classroom" data-tap="0">909</div>
                    <div class="classroom" data-tap="0">910</div>
                    <div class="classroom" data-tap="0">912</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 10</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1001</div>
                    <div class="classroom" data-tap="0">1002</div>
                    <div class="classroom" data-tap="0">1004</div>
                    <div class="classroom" data-tap="0">1005</div>
                    <div class="classroom" data-tap="0">1006</div>
                    <div class="classroom" data-tap="0">1007</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 11</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1101</div>
                    <div class="classroom" data-tap="0">1102</div>
                    <div class="classroom" data-tap="0">1104</div>
                    <div class="classroom" data-tap="0">1105</div>
                    <div class="classroom" data-tap="0">1106</div>
                    <div class="classroom" data-tap="0">1107</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
            <div class="level-container">
                <div class="level-title">Level 12</div>
                <div class="classroom-grid">
                    <div class="classroom" data-tap="0">1203</div>
                    <div class="classroom" data-tap="0">1204</div>
                    <div class="classroom" data-tap="0">1205</div>
                    <div class="classroom" data-tap="0">1206</div>
                    <div class="classroom" data-tap="0">1207</div>
                    <div class="classroom" data-tap="0">1208</div>
                </div>
                <div class="level-issues-container"></div>
            </div>
        </section>
    </main>

    <script>
        // 1. Define global variables for BOTH codes
        let correctAuthCode = null;
        let correctExportAuthCode = null;

        // 4. Setup DOMContentLoaded listener to fetch codes and add keypress listeners
        document.addEventListener("DOMContentLoaded", function () {

            // --- 1. Centralized Role Check ---
            const userRole = sessionStorage.getItem('userRole');
            
            // If no role is found, the user hasn't logged in. Redirect them.
            if (!userRole) {
                alert("Access Denied. Please log in first.");
                window.location.href = 'index.html';
                return; // Stop further script execution
            }
            
            console.log(`Access granted with role: ${userRole}`);

            // --- 2. Determine Campus ID ---
            const pageTitleElement = document.querySelector('h1');
            if (pageTitleElement) {
                const pageTitle = pageTitleElement.innerText.toLowerCase();
                if (pageTitle.includes('beirut')) {
                    window.campusPageId = 'beirut';
                } else if (pageTitle.includes('byblos')) {
                    window.campusPageId = 'byblos';
                } else {
                    window.campusPageId = 'unknown_campus';
                    console.error("Could not determine campus from page title:", pageTitleElement.innerText);
                }
                console.log("üè´ Campus identified as:", window.campusPageId);
            } else {
                window.campusPageId = 'unknown_campus';
                console.error("H1 tag not found, cannot determine campus.");
            }

            // --- 3. Role-Based UI Adjustments ---
            const exportButton = document.getElementById('exportLogButton');
            const muteButton = document.getElementById('muteButton');

            // Display Export Button ONLY for Admins
            if (exportButton) {
                exportButton.style.display = (userRole === 'admin') ? 'inline-block' : 'none';
            }

            // Hide Mute Button for End-Users (show only for admin/support)
            if (muteButton) {
                if (userRole !== 'admin' && userRole !== 'support') {
                    muteButton.style.display = 'none';
                }
            }

            // --- Role-Based Styling for Cursor ---
            // If the user is an end-user, inject a CSS rule to change the cursor
            // on classrooms that are already in an issue state (red or yellow).
            if (userRole !== 'admin' && userRole !== 'support') {
                document.body.classList.add('role-end-user');
                
                const style = document.createElement('style');
                style.textContent = `
                    body.role-end-user .classroom.blink-red,
                    body.role-end-user .classroom.blink-yellow {
                        cursor: default;
                    }
                `;
                document.head.appendChild(style);
                console.log("Applied 'end-user' specific cursor styles.");
            }


            // Fetch authentication codes from Firebase
            if (window.ENV && window.ENV.FIREBASE_CONFIG && window.ENV.FIREBASE_CONFIG.databaseURL) {
                const dbURL = window.ENV.FIREBASE_CONFIG.databaseURL.replace(/\/$/, '');
                // We no longer need the initialAuthUrl
                const exportAuthUrl = `${dbURL}/exportAuthCode.json`; 

                fetch(exportAuthUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for exportAuthCode`);
                        return response.json();
                    })
                    .then(exportCode => {
                        // Assign the fetched code to the GLOBAL variable
                        correctExportAuthCode = exportCode;
                        console.log("‚úÖ Export Authentication Code Loaded");
                    })
                    .catch(error => {
                        console.error("‚ùå Failed to load the export authentication code:", error);
                        alert("Error loading authentication configuration. The export feature might be disabled.");
                    });
            } else {
                 console.error("‚ùå Firebase databaseURL not found in config.js. Cannot fetch auth codes.");
                 alert("Firebase configuration error. Authentication unavailable.");
            }

            // document.body.style.visibility = 'visible';
            requestAnimationFrame(() => {
            document.body.style.opacity = '1';
            });
            // --- batch mode/single mode view ---
            const urlParams = new URLSearchParams(window.location.search);
            const buildingParam = urlParams.get('building');
            const levelParam = urlParams.get('level');
            const roomParam = urlParams.get('room');
            const mode = urlParams.get('mode');
            const filterClassroomIssues = urlParams.get('filterClassroomIssues') === 'true';
            const viewOnly = urlParams.get('viewOnly') === 'true';
            const fromBatch = urlParams.get('fromBatch') === 'true';

            // --- Global flag for batch mode ---
            window.isBatchMode = fromBatch;
            console.log("Batch mode status:", window.isBatchMode);

            // --- Audio Unlock Prompt for Admin/Support ---
            // This prompt ensures the browser's audio context is unlocked by an explicit user click.
            if ((userRole === 'admin' || userRole === 'support') && !window.isBatchMode) {
                // First, inject the necessary CSS for the overlay
                const style = document.createElement('style');
                style.textContent = `
                    #audio-unlock-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.6);
                        color: white;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        font-size: 1.5rem;
                        font-weight: bold;
                        font-family: sans-serif;
                        cursor: pointer;
                        z-index: 9999;
                        text-align: center;
                        padding: 20px;
                    }
                `;
                document.head.appendChild(style);

                // Create and display the overlay
                const overlay = document.createElement('div');
                overlay.id = 'audio-unlock-overlay';
                overlay.textContent = 'Click anywhere to enable sound notifications';
                document.body.appendChild(overlay);

                // The click on this overlay serves as the first user interaction on the page,
                // which will trigger the existing audio unlock listener.
                overlay.addEventListener('click', function() {
                    // This simply removes the overlay. The browser click event itself will
                    // be captured by the existing audio unlock listener.
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                    console.log("üîä Sound notifications enabled by user click.");
                }, { once: true });
            }

            // Activate single classroom mode only if all parameters are present
            if (mode === 'single' && buildingParam && levelParam && roomParam) {
                console.log(`Entering single classroom mode: ${buildingParam} / ${levelParam} / ${roomParam}`);
                document.body.classList.add('single-classroom-mode');

                // Hide all building containers initially
                document.querySelectorAll('.building-container').forEach(building => {
                    building.style.display = 'none';
                });

                // Find and show only the requested building, level, and classroom
                 let foundClassroom = false;
                 const buildings = document.querySelectorAll('.building-container');
                 const normalizedLevelParam = levelParam.replace('Level ', '');

                 buildings.forEach(building => {
                     const buildingName = building.querySelector('h2')?.innerText;
                     if (buildingName === buildingParam) {
                         building.style.display = 'block';
                         const levels = building.querySelectorAll('.level-container');
                         levels.forEach(level => {
                             const levelTitle = level.querySelector('.level-title')?.innerText;
                             if (levelTitle && levelTitle.endsWith(normalizedLevelParam)) {
                                 level.style.display = 'block';
                                 const classrooms = level.querySelectorAll('.classroom');
                                 classrooms.forEach(classroom => {
                                     if (classroom.innerText === roomParam) {
                                         foundClassroom = true;
                                         classroom.style.display = 'block';
                                         if (viewOnly) {
                                         }
                                     } else {
                                         classroom.style.display = 'none';
                                     }
                                 });
                                 if (!filterClassroomIssues) {
                                      const levelIssues = level.querySelector('.level-issues-container');
                                      if (levelIssues) levelIssues.style.display = 'none';
                                 }
                             } else {
                                 level.style.display = 'none';
                             }
                         });
                     }
                 });
                 // Adjust layout if found
                 if (foundClassroom) {
                     console.log("Single classroom found, adjusting layout.");
                 } else {
                      console.warn(`Single classroom mode failed: Classroom ${buildingParam}/${levelParam}/${roomParam} not found in HTML.`);
                 }
            } // End Single Mode Logic

            // start batch mode specific ui changes
            if (window.isBatchMode) {
                console.log("Applying Batch Mode specific UI changes...");

                // --- Requirement 1: Hide Mute and Export Buttons ---
                const muteButton = document.getElementById('muteButton');
                const exportLogButton = document.getElementById('exportLogButton');

                if (muteButton) {
                    muteButton.style.display = 'none';
                    console.log("Mute button hidden for batch mode.");
                }
                if (exportLogButton) {
                    exportLogButton.style.display = 'none';
                    console.log("Export log button hidden for batch mode.");
                }
                // --- End Requirement 1 ---

                const backButton = document.querySelector('.back-button'); //
                if (backButton) {
                    backButton.style.display = 'none';
                    console.log("Back button hidden for batch mode.");
                }

                // --- Requirement 2 Setup ---
                 if (roomParam && buildingParam && levelParam) {
                    console.log("Applying batch mode text styling for room:", roomParam);
                    const style = document.createElement('style');
                    const normalizedLevelParam = levelParam.replace('Level ', '');
                    style.textContent = `
                        /* Append room number to level title */
                        .level-title[data-batch-mode]::after {
                            content: "- Classroom ${roomParam}";
                            font-weight: bold;
                            color: black;
                            margin-left: 5px;
                        }
                        /* Style the classroom button in batch mode */
                        .classroom[data-batch-mode] {
                           position: relative; /* Needed for ::after positioning */
                           color: transparent !important; /* Hide original number text */
                           min-width: 120px; /* Ensure enough width for 'Report Issue' */
                           padding: 5px; /* Adjust padding if needed */
                           font-weight: normal; /* Override bold from default .classroom if needed */
                        }
                        /* Add text using ::after */
                        .classroom[data-batch-mode]::after {
                          content: "Report Issue"; /* Text to display */
                          position: absolute;
                          left: 50%;
                          top: 50%;
                          transform: translate(-50%, -50%);
                          color: white; /* Ensure text color is visible */
                          pointer-events: none; /* Doesn't block clicks on the main element */
                          font-size: 0.8rem; /* Adjust size as needed */
                          font-weight: bold;
                          white-space: nowrap;
                          width: 100%;
                          text-align: center;
                        }
                    `;
                    document.head.appendChild(style);

                    // Add data attributes to matching elements for the CSS selectors
                    document.querySelectorAll('.building-container').forEach(building => {
                        if (building.querySelector('h2')?.innerText === buildingParam) {
                            building.querySelectorAll('.level-container').forEach(level => {
                                const levelTitle = level.querySelector('.level-title');
                                if (levelTitle?.innerText.endsWith(normalizedLevelParam)) {
                                    levelTitle.setAttribute('data-batch-mode', 'true');
                                    level.querySelectorAll('.classroom').forEach(classroom => {
                                        if (classroom.innerText === roomParam) {
                                            classroom.setAttribute('data-batch-mode', 'true');
                                        }
                                    });
                                }
                            });
                        }
                    });
                 } 
            }
            // end batch mode specific ui changes
        });
        // end domcontentloaded listener
    </script>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, update, get, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { firebaseConfig as importedFirebaseConfig } from './config.js';
         import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-messaging.js";

        // Ensure Firebase Config is Loaded
        window.ENV = window.ENV || {};
        if (!window.ENV.FIREBASE_CONFIG) {
            window.ENV.FIREBASE_CONFIG = importedFirebaseConfig;
        }

        // Check if the configuration is now available
        if (!window.ENV || !window.ENV.FIREBASE_CONFIG) {
            console.error("‚ùå Firebase configuration is missing. Ensure config.js is correct and accessible!");
            alert("Firebase configuration error. App cannot initialize.");
        }
        
        // Initialize Firebase using the config now on window.ENV
        const app = initializeApp(window.ENV.FIREBASE_CONFIG);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Expose Firebase functions to window for easier access in other scripts
        window.firebaseTools = {
            database,
            ref,
            onValue,
            push,
            set,
            update,
            get, 
            remove,
            serverTimestamp
        };

        // logActivity function ===
        async function logActivity(logEntry, logId = null) {
            const campusPrefix = window.campusPageId;
            if (!campusPrefix || campusPrefix === 'unknown_campus') {
                console.error("‚ùå Campus ID not set or unknown. Cannot log activity.");
                // alert("Application error: Campus context is missing. Logging aborted.");
                return null;
            }

            // Basic validation
            if (!window.firebaseTools || !logEntry || !logEntry.building || !logEntry.classroom || !logEntry.action) {
                console.error("‚ùå Cannot log activity: Missing required fields (building, classroom, action).", logEntry);
                return null;
            }

            const { database, ref, push, update, serverTimestamp, set, get } = window.firebaseTools;
            const basePath = `${campusPrefix}/activityLog/${logEntry.building}/${logEntry.classroom}`;

            // --- Helper to format timestamp ---
            const formatTimestamp = (ts) => {
                if (!ts) return 'N/A';
                try {
                    const date = new Date(ts);
                     // Check if date is valid
                    if (isNaN(date.getTime())) {
                        // Handle Firebase ServerValue.TIMESTAMP placeholder if needed, or return default
                        return 'Pending...';
                    }
                    // Format: YYYY-MM-DD HH:MM:SS (24-hour)
                    return date.toISOString().replace('T', ' ').substring(0, 19);
                } catch (e) {
                    console.error("Error formatting timestamp:", ts, e);
                    return 'Invalid Date';
                }
            };


            try {
                if (logId) {
                    // --- Update existing log entry ---
                    const logRef = ref(database, `${basePath}/${logId}`);

                    // Fetch the current log entry to append history correctly
                    const snapshot = await get(logRef);
                    const currentLog = snapshot.val() || {};
                    const currentHistory = currentLog.actionHistory || [];

                    // Prepare the update object
                    const updates = {};
                    const now = serverTimestamp();

                    // Add the new action details to the history array
                    updates[`actionHistory/${currentHistory.length}`] = {
                        action: logEntry.action,
                        details: logEntry.details || {},
                        timestamp: now,
                    };
                    // Update the main action field and timestamp to reflect the latest status
                    updates['currentAction'] = logEntry.action;
                    updates['lastUpdatedTimestamp'] = now;

                    // Perform the update using the update() method
                    await update(logRef, updates);
                    console.log(`üìù Activity log UPDATED for ${campusPrefix}/${logEntry.building} ${logEntry.classroom} (ID: ${logId}): ${logEntry.action}`);
                    return logId;

                } else {
                    // --- Create new log entry ---
                    const logCollectionRef = ref(database, basePath);
                    const newLogRef = push(logCollectionRef);
                    const now = serverTimestamp();

                    // Prepare the initial log data structure
                    const initialLogData = {
                        logCycleId: newLogRef.key,
                        building: logEntry.building,
                        classroom: logEntry.classroom,
                        initialTimestamp: now,
                        lastUpdatedTimestamp: now,
                        currentAction: logEntry.action,
                        actionHistory: [
                            {
                                action: logEntry.action,
                                details: logEntry.details || {},
                                timestamp: now,
                            }
                        ]
                    };

                    // Set the initial data for the new log entry
                    await set(newLogRef, initialLogData);
                    console.log(`üìù Activity log CREATED for ${campusPrefix}/${logEntry.building} ${logEntry.classroom} (ID: ${newLogRef.key}): ${logEntry.action}`);
                    return newLogRef.key;
                }
            } catch (error) {
                console.error("‚ùå Error in logActivity:", error, "Data:", logEntry, "Log ID:", logId);
                return null;
            }
        }
        // Make it globally accessible
        window.logActivity = logActivity;
        // end logActivity function


        // === Audio System ===
        let audioUnlocked = false;
        const audio = document.getElementById("peepSound");
        // Cooldown variable for playSound
        let soundCooldown = false;

        // Function to unlock audio context on first user interaction
        function unlockAudio() {
            if (!audioUnlocked && audio.paused) {
                audio.play().then(() => {
                    // Playback started successfully, pause immediately
                    audio.pause();
                    audioUnlocked = true;
                    console.log("üîä Audio Context Unlocked");
                }).catch(error => {
                    // Autoplay was prevented, user interaction needed
                    console.warn("Audio unlock failed:", error);
                    // Keep audioUnlocked false, retry on next interaction
                });
            } else if (!audioUnlocked) {
                // If audio wasn't paused (e.g., already playing somehow), mark unlocked
                audioUnlocked = true;
                 console.log("üîä Audio Context already active or unlocked");
            }
        }
        // Add listeners for first interaction
        document.addEventListener("click", unlockAudio, { once: true });
        document.addEventListener("keydown", unlockAudio, { once: true });
        document.addEventListener("touchstart", unlockAudio, { once: true });


        // === Mute Button Logic ===
        let isMuted = false;
        const muteButton = document.getElementById("muteButton");
        const urlParamsMute = new URLSearchParams(window.location.search);
        // Mute if 'fromBatch=true' or 'muted=true' is in URL
        if (urlParamsMute.get('muted') === 'true') {
            isMuted = true;
            audio.muted = true;
            if (muteButton) muteButton.innerHTML = "üîá"; 
            console.log("Audio muted via URL parameter.");
        }
        // Toggle mute on button click
        if (muteButton) { // Check if muteButton exists before adding listener
            muteButton.addEventListener("click", () => {
                isMuted = !isMuted;
                audio.muted = isMuted;
                muteButton.innerHTML = isMuted ? "üîá" : "üîä"; 
                console.log(isMuted ? "Audio Muted" : "Audio Unmuted");
            });
        }


        // function to Play Sound ===
        // plays the sound only if audio is unlocked, not muted, and not on cooldown
        function playSound() {
            // Check cooldown flag 
            if (audioUnlocked && !isMuted && !soundCooldown && !window.isBatchMode) {
                audio.currentTime = 0;
                audio.play().catch(error => console.error("Error playing sound:", error));

                // Set cooldown flag and timeout
                soundCooldown = true;
                // Set a short timeout (e.g., 500ms) to reset the cooldown flag
                setTimeout(() => {
                    soundCooldown = false;
                }, 500); // Adjust timeout duration if needed

            } else if (!audioUnlocked) {
                console.warn("Audio not unlocked, cannot play sound.");
            } else if (isMuted) {
                 console.log("Audio muted, sound suppressed.");
            } else if (soundCooldown) {
                 console.log("Sound cooldown active, suppressing duplicate play.");
            }
        }

        // === Function to Trigger Global Sound ===
        // Writes to Firebase to trigger sound on other clients
        function triggerGlobalSound(buildingName, classroomName) {
            const campusPrefix = window.campusPageId;
            if (!campusPrefix || campusPrefix === 'unknown_campus') {
                console.error("‚ùå Campus ID not set or unknown. Cannot trigger global sound.");
                return;
            }

            // The global trigger should be sent regardless of the local user's mute status.
            // Receiving clients will decide whether to play the sound based on their own role and mute status.
            const { database, ref, set, serverTimestamp } = window.firebaseTools;
            const triggerRef = ref(database, `${campusPrefix}/soundTrigger`);
            
            // Set a value with a timestamp to ensure it's a new event
            set(triggerRef, {
                building: buildingName,
                classroom: classroomName,
                timestamp: serverTimestamp() // Use server time
            }).then(() => {
                console.log(`üîä Sound trigger sent for ${campusPrefix}/${buildingName} ${classroomName}`);
            }).catch(error => {
                console.error("‚ùå Error sending sound trigger:", error);
            });
        }
        // Make triggerGlobalSound globally accessible
        window.triggerGlobalSound = triggerGlobalSound;

        const checkFirebaseSoundTrigger = setInterval(() => {
            // Ensure Firebase tools are ready and campusPageId is valid
            if (window.firebaseTools && window.firebaseTools.database && window.campusPageId && window.campusPageId !== 'unknown_campus') {
                clearInterval(checkFirebaseSoundTrigger);
                initializeSoundTriggerListener(); // Call a new function to encapsulate the logic
                console.log(`‚úÖ Sound Trigger Listener System Initialized for ${window.campusPageId}.`);
            } else if (window.campusPageId === 'unknown_campus') {
                clearInterval(checkFirebaseSoundTrigger); // Stop trying if campus is definitively unknown
                console.error("üö® Sound Trigger Listener System NOT Initialized: Campus ID is unknown.");
            }
            // If window.campusPageId is not yet set, the interval continues
        }, 100); // Check every 100ms

        function initializeSoundTriggerListener() {
            const campusPrefixForSound = window.campusPageId;
            const { database, ref, onValue } = window.firebaseTools; // Destructure here
            const soundTriggerRef = ref(database, `${campusPrefixForSound}/soundTrigger`);
            let lastTriggerTimestamp = Date.now();
            let isProcessingSoundTrigger = false;

            onValue(soundTriggerRef, (snapshot) => {
                if (isProcessingSoundTrigger) {
                    return;
                }
                if (snapshot.exists()) {
                    const triggerData = snapshot.val();
                    if (triggerData.timestamp && triggerData.timestamp > lastTriggerTimestamp) {
                        isProcessingSoundTrigger = true;
                        lastTriggerTimestamp = triggerData.timestamp; 
                        console.log(`üîä Received sound trigger for ${campusPrefixForSound}:`, triggerData);
                        
                        // Check user role before playing sound
                        const userRole = sessionStorage.getItem('userRole');
                        // Play sound only for 'admin' or 'support' roles.
                        if (userRole === 'admin' || userRole === 'support') {
                            playSound(); 
                        } else {
                            console.log(`Sound alert suppressed for user role: ${userRole}`);
                        }
                        
                        setTimeout(() => {
                            isProcessingSoundTrigger = false;
                        }, 100);
                    }
                }
            }, (error) => {
                console.error(`‚ùå Error listening for sound triggers on ${campusPrefixForSound}:`, error);
                isProcessingSoundTrigger = false;
            });
        }
        // === END Audio System ===


        // === MODIFIED toggleColor FUNCTION (Handles state, modals, logging, and issue removal) ===
        /**
         * Handles clicks on classroom elements, managing state transitions,
         * opening modals, and coordinating activity logging.
         * @param {HTMLElement} element - The clicked classroom div.
         */
        async function toggleColor(element) {
            // --- 1. Initial Setup and Validation ---
            const campusPrefix = window.campusPageId;
            if (!campusPrefix || campusPrefix === 'unknown_campus') {
                console.error("‚ùå Campus ID not set or unknown. Cannot perform action.");
                alert("Application error: Campus context is missing.");
                return;
            }

            console.log("üîµ Click detected on:", element.innerText);
            const { database, ref, get, update, remove } = window.firebaseTools;
            const urlParamsView = new URLSearchParams(window.location.search);
            const viewOnly = urlParamsView.get('viewOnly') === 'true';
            const userRole = sessionStorage.getItem('userRole');

            // Block all actions in view-only mode
            if (viewOnly) {
                console.log("View-only mode: Action blocked.");
                return;
            }

            // --- 2. End-User Specific Logic ---
            // If the user is not an admin or support member, they have limited actions.
            if (userRole !== 'admin' && userRole !== 'support') {
                const isOriginal = !element.classList.contains("blink-red") && !element.classList.contains("blink-yellow");
                
                // End-users can only click an original classroom to report an issue.
                if (isOriginal) {
                    console.log("Action: Reporting Issue (End-User)");
                    window.openIssueModal(element);
                } else {
                    // If the classroom is red or yellow, the click does nothing for an end-user.
                    console.log(`Action blocked for role '${userRole}' on a non-original classroom.`);
                }
                return; // Stop further execution for end-users
            }

            // --- 3. Admin & Support Logic ---
            // The following code only runs for 'admin' or 'support' roles.
            const classroomName = element.innerText;
            const buildingName = element.closest(".building-container").querySelector("h2").innerText;
            const classroomPath = `${campusPrefix}/classrooms/${buildingName}/${classroomName}`;
            const classroomRef = ref(database, classroomPath);

            let currentClassroomData = {};
            let activeLogId = null;
            try {
                const snapshot = await get(classroomRef);
                if (snapshot.exists()) {
                    currentClassroomData = snapshot.val();
                    activeLogId = currentClassroomData.activeLogId || null;
                }
            } catch (error) {
                console.error("‚ùå Error fetching classroom data before toggle:", error);
                alert("Error fetching classroom status. Please try again.");
                return;
            }

            // --- Action for YELLOW classroom (Issue Handled -> Solved) ---
            if (element.classList.contains("blink-yellow")) {
                if (window.isBatchMode) {
                    console.log("Batch mode: Clicking yellow button is disabled.");
                    return;
                }
                console.log("Action: Solving Handled Issue (Admin/Support)");
                try {
                    // Reset state in Firebase
                    await update(classroomRef, { tapCount: 0, color: "original", activeLogId: null });
                    console.log(`‚úÖ Classroom ${classroomPath} reset in Firebase.`);

                    if (activeLogId) {
                        // Remove the corresponding issue from the `/issues` node
                        const issuesPath = `${campusPrefix}/issues`;
                        const issuesSnapshot = await get(ref(database, issuesPath));
                        if (issuesSnapshot.exists()) {
                            let issueKeyToDelete = Object.keys(issuesSnapshot.val()).find(key => issuesSnapshot.val()[key]?.logId === activeLogId);
                            if (issueKeyToDelete) {
                                await remove(ref(database, `${issuesPath}/${issueKeyToDelete}`));
                                console.log(`‚úÖ Associated issue ${issueKeyToDelete} removed.`);
                            }
                        }
                        // Log the "ISSUE_SOLVED" action
                        await logActivity({ action: "ISSUE_SOLVED", building: buildingName, classroom: classroomName }, activeLogId);
                    }
                } catch (error) {
                    console.error("‚ùå Error solving issue:", error);
                    alert("Error solving issue status.");
                }
                return;
            }

            // --- Action for RED classroom (Issue Reported) ---
            if (element.classList.contains("blink-red")) {
                if (window.isBatchMode) {
                    console.log("Batch mode: Clicking red button is disabled.");
                    return;
                }
                console.log("Action: Handling Reported Issue (Admin/Support)");
                // Open the 'Handle Issue' modal
                window.trackHandledClassroom(element);
                document.getElementById("handledClassroomName").textContent = `${buildingName} ${classroomName}`;
                document.getElementById("handleIssueModal").style.display = "flex";
                document.getElementById("mainContent").classList.add("blurred");
                document.getElementById("handleIssueForm").style.display = "";
                document.getElementById("handleIssueSuccessMessage").style.display = "none";
                document.getElementById("staffNameSelect").value = "";
                document.getElementById("submitHandledIssue").disabled = true;
                return;
            }
            
            // --- Action for ORIGINAL classroom (No Issue) ---
            const isOriginal = !element.classList.contains("blink-red") && !element.classList.contains("blink-yellow");
            if (isOriginal) {
                console.log("Action: Reporting New Issue (Admin/Support)");
                window.openIssueModal(element);
            }
        }
        // === END MODIFIED toggleColor FUNCTION ===

        // Sync Classrooms from Firebase (Reads state and applies classes)
        function syncClassrooms() {
            const campusPrefix = window.campusPageId;
            if (!campusPrefix || campusPrefix === 'unknown_campus') {
                console.warn("üö® Campus ID not set or unknown. Cannot sync classrooms.");
                // Reset all classrooms to original visually if campus is unknown
                document.querySelectorAll(".classroom").forEach(classroom => {
                    classroom.classList.remove("blink-red", "blink-yellow", "clicked");
                    classroom.classList.add("original");
                    classroom.dataset.tap = "0";
                });
                return;
            }

            console.log(`üîÑ Syncing classroom states with Firebase for ${campusPrefix}...`);
            const classroomsPath = `${campusPrefix}/classrooms`;
            const classroomsRef = ref(database, classroomsPath);

            onValue(classroomsRef, (snapshot) => {
                if (!snapshot.exists()) {
                    console.warn(`‚ö†Ô∏è No classroom data found in Firebase at '${classroomsPath}'.`);
                    document.querySelectorAll(".classroom").forEach(classroom => {
                        classroom.classList.remove("blink-red", "blink-yellow", "clicked");
                        classroom.classList.add("original");
                        classroom.dataset.tap = "0"; 
                    });
                    return;
                }

                const allClassroomsData = snapshot.val();
                console.log(`üì° Received classroom data from Firebase for ${campusPrefix}:`, allClassroomsData);

                document.querySelectorAll(".building-container").forEach(buildingContainer => {
                    const buildingName = buildingContainer.querySelector("h2").innerText;
                    const buildingData = allClassroomsData[buildingName]; 

                    buildingContainer.querySelectorAll(".classroom").forEach(classroomElement => {
                        const classroomNumber = classroomElement.innerText;
                        const classroomData = buildingData ? buildingData[classroomNumber] : null; 

                        classroomElement.classList.remove("blink-red", "blink-yellow", "original", "clicked");

                        if (classroomData) {
                            if (classroomData.color === "yellow") {
                                classroomElement.classList.add("blink-yellow");
                                classroomElement.dataset.tap = "2"; 
                            } else if (classroomData.color === "red") {
                                classroomElement.classList.add("blink-red", "clicked");
                                classroomElement.dataset.tap = "1"; 
                            } else {
                                classroomElement.classList.add("original");
                                classroomElement.dataset.tap = "0";
                            }
                            classroomElement.dataset.activeLogId = classroomData.activeLogId || '';
                        } else {
                            classroomElement.classList.add("original");
                            classroomElement.dataset.tap = "0";
                            classroomElement.dataset.activeLogId = ''; 
                        }
                    });
                });
                 console.log(`‚úÖ Classroom states synced for ${campusPrefix}.`);
            }, (error) => {
                console.error(`‚ùå Firebase Sync Error for ${campusPrefix}:`, error);
                alert(`Error syncing classroom states for ${campusPrefix}. Please refresh.`);
            });
        }

        // Initialize everything when the page loads
        window.onload = function() {
            console.log("üöÄ Page loaded, initializing sync and setting up clicks...");
            if (window.campusPageId && window.campusPageId !== 'unknown_campus') {
                syncClassrooms(); // Sync classroom states on load
            } else {
                console.error("üö® Cannot initialize page: Campus ID is not set or unknown.");
                alert("Fatal Error: Application campus context is missing. Please contact support.");
            }
            

             document.querySelectorAll(".classroom").forEach(classroom => {
                 classroom.removeAttribute('onclick');
                 classroom.addEventListener('click', function() {
                     window.toggleColor(this); 
                 });
             });
             console.log("‚úÖ Classroom click handlers assigned.");
        };

        window.toggleColor = toggleColor; 

        let messaging;
const VAPID_KEY = "BOD99XqIbdfLXNIfPvONwKBa6YRHH4YVRbswAvj8PMVqJRuCVW3RD3XdpPJ4YLyN0DGxSuiuvZuTyvOa5inK76o"; // IMPORTANT: Replace with your actual VAPID key from Firebase Console

// Function to request notification permission and get token (re-used for consistency)
async function requestNotificationPermissionAndGetToken(userRole) {
    if (!('Notification' in window) || !('serviceWorker' in navigator) || !VAPID_KEY) {
        console.warn('Notifications not supported or VAPID key missing.');
        return;
    }
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            messaging = getMessaging(app); // Ensure 'app' is accessible (initialized Firebase app)
            const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
            if (currentToken) {
                console.log('FCM registration token:', currentToken);
                await saveMessagingTokenToDatabase(currentToken, userRole);
            } else {
                console.log('No FCM registration token available. Request permission to generate one.');
            }
        } else {
            console.warn('Notification permission denied or dismissed.');
        }
    } catch (error) {
        console.error('Error getting FCM token:', error);
    }
}

// Function to save the token to Firebase Realtime Database
async function saveMessagingTokenToDatabase(token, userRole) {
    const fcmTokensRef = ref(database, `fcmTokens/<span class="math-inline">\{userRole\}/</span>{token}`);
    try {
        await set(fcmTokensRef, {
            token: token,
            timestamp: serverTimestamp(),
            lastAccessedRole: userRole,
        });
        console.log(`FCM token saved for role: ${userRole}`);
    } catch (error) {
        console.error('Error saving FCM token to database:', error);
    }
}

// Call this after the user role is confirmed (e.g., in DOMContentLoaded or after a successful login check)
document.addEventListener("DOMContentLoaded", function () {
    const userRole = sessionStorage.getItem('userRole');
    if (userRole) {
        requestNotificationPermissionAndGetToken(userRole);
    }

});
    </script>

    <script type="module"> 
        const checkFirebaseReporting = setInterval(() => {
            if (window.firebaseTools && typeof window.logActivity === 'function' && typeof window.triggerGlobalSound === 'function' && window.campusPageId && window.campusPageId !== 'unknown_campus') {
                clearInterval(checkFirebaseReporting);
                initIssueReporting();
                console.log(`‚úÖ Issue Reporting System Initialized for ${window.campusPageId}.`);
            } else if (window.campusPageId === 'unknown_campus') {
                 clearInterval(checkFirebaseReporting); // Stop trying if campus is unknown
                 console.error("üö® Issue Reporting System NOT Initialized: Campus ID is unknown.");
            }
        }, 100);

        function initIssueReporting() {
            const campusPrefix = window.campusPageId;
            const { database, ref, set, push, update, serverTimestamp } = window.firebaseTools;

            const issueModal = document.getElementById("issueModal");
            const classroomNameSpan = document.getElementById("classroomName");
            const issueButtons = document.querySelectorAll(".issue-btn");
            const customIssueInput = document.getElementById("customIssue");
            const detailsInput = document.getElementById("issueDetails"); 
            const submitIssueBtn = document.getElementById("submitIssue");
            const successMessageDiv = document.getElementById("successMessage"); 
            const closeButton = document.querySelector("#issueModal .close-button"); 

            let currentClassroomElement = null; 
            let selectedIssues = []; 

            const urlParams = new URLSearchParams(window.location.search);
            const viewOnly = urlParams.get('viewOnly') === 'true';
            const fromBatch = urlParams.get('fromBatch') === 'true';
            const username = urlParams.get('user') || 'unknown'; 
            const ipAddress = urlParams.get('ip') || 'unknown';   

            window.openIssueModal = function(element) {
                if (viewOnly) {
                    console.log("View-only mode: Cannot open issue report modal.");
                    return;
                }
                if (!element.classList.contains("original")) {
                    console.log("Issue modal blocked: Classroom is not in 'original' state.");
                    return;
                }

                console.log("Opening issue modal for:", element.innerText);
                currentClassroomElement = element; 
                const buildingName = element.closest(".building-container").querySelector("h2").innerText;
                classroomNameSpan.textContent = `${buildingName} ${element.innerText}`; 

                issueModal.classList.add("active");
                issueModal.style.display = "flex";
                document.getElementById("mainContent").classList.add("blurred");

                selectedIssues = []; 
                issueButtons.forEach(btn => btn.classList.remove("active")); 
                customIssueInput.value = ""; 
                detailsInput.value = "";     
                submitIssueBtn.disabled = true; 
                successMessageDiv.style.display = "none"; 
                document.querySelector("#issueModal h2").style.display = "block";
                document.querySelector(".issue-buttons").style.display = ""; 
                customIssueInput.style.display = "block"; 
                detailsInput.style.display = "block";     
                submitIssueBtn.style.display = "inline-block"; 
                closeButton.style.display = "flex"; 

                if (issueButtons.length > 0) {
                    issueButtons[0].focus();
                }
            };

            issueButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const issue = this.dataset.issue; 
                    if (this.classList.contains("active")) {
                        this.classList.remove("active");
                        selectedIssues = selectedIssues.filter(item => item !== issue);
                    } else {
                        this.classList.add("active");
                        selectedIssues.push(issue);
                    }
                    updateSubmitButtonState(); 
                });
            });

            customIssueInput.addEventListener("input", updateSubmitButtonState);

            function updateSubmitButtonState() {
                const hasSelectedIssues = selectedIssues.length > 0;
                const hasCustomIssue = customIssueInput.value.trim() !== "";
                submitIssueBtn.disabled = !(hasSelectedIssues || hasCustomIssue);
            }

            submitIssueBtn.addEventListener("click", async function() { 
                if (submitIssueBtn.disabled || !currentClassroomElement) {
                    console.warn("Submit issue blocked: Button disabled or no classroom selected.");
                    return;
                }

                submitIssueBtn.disabled = true; 
                console.log("Submitting issue...");

                let allIssues = [...selectedIssues]; 
                const customIssueText = customIssueInput.value.trim();
                if (customIssueText !== "") {
                    allIssues.push(customIssueText); 
                }
                const detailsText = detailsInput.value.trim(); 
                const buildingName = currentClassroomElement.closest(".building-container").querySelector("h2").innerText;
                const levelElement = currentClassroomElement.closest(".level-container").querySelector(".level-title");
                const level = levelElement ? levelElement.innerText.replace("Level ", "") : "N/A"; 
                const classroomName = currentClassroomElement.innerText;

                const logData = {
                    action: "ISSUE_REPORTED", 
                    building: buildingName,
                    classroom: classroomName,
                    details: {
                        issues: allIssues.join(", "), 
                        description: detailsText,     
                        reportedBy_User: username,    
                        reportedBy_IP: ipAddress,     
                        fromBatchMode: fromBatch,     
                        level: level                  
                    }
                };
                const newLogId = await window.logActivity(logData, null);

                if (!newLogId) {
                    console.error("‚ùå Failed to create activity log entry. Aborting issue report.");
                    alert("Error logging activity. Issue not reported. Please try again.");
                    submitIssueBtn.disabled = false; 
                    return; 
                }
                console.log(`‚úÖ Activity log entry created with ID: ${newLogId} for ${campusPrefix}.`);

                const issueData = {
                    building: buildingName,
                    level: level,
                    classroom: classroomName,
                    issues: allIssues.join(", "),
                    description: detailsText,
                    timestamp: serverTimestamp(), 
                    username: username,
                    ip: ipAddress,
                    fromBatch: fromBatch,
                    status: "reported", 
                    logId: newLogId     
                };
                const issuesPath = `${campusPrefix}/issues`;
                const newIssueRef = push(ref(database, issuesPath)); 
                try {
                    await set(newIssueRef, issueData);
                    console.log(`‚úÖ Issue saved to '${issuesPath}' node with key: ${newIssueRef.key}`);
                    // --- NEW: Trigger notification for Admins/Support ---
                    // This data will be picked up by a Firebase Cloud Function
                    // to send push notifications to registered admin/support devices.
                    const notificationTriggerRef = ref(database, `notificationTriggers/newClassroomIssue`);
                    await push(notificationTriggerRef, {
                        issueId: newIssueRef.key,
                        building: buildingName,
                        classroom: classroomName,
                        summary: allIssues.join(", "),
                        timestamp: serverTimestamp(),
                        // Add specific roles to notify if needed for more granular control
                        targetRoles: ['admin', 'support']
                    });
                    console.log("üîî Notification trigger sent for new classroom issue.");
                    // --- END NEW ---
                } catch (error) {
                     console.error(`‚ùå Error saving issue to '${issuesPath}' node:`, error);
                     alert("Error saving issue details. The activity was logged, but details might be missing.");
                }

                const classroomPath = `${campusPrefix}/classrooms/${buildingName}/${classroomName}`;
                const classroomRef = ref(database, classroomPath);
                const classroomUpdate = {
                    tapCount: 1, 
                    color: "red",
                    activeLogId: newLogId 
                };
                try {
                    document.querySelector("#issueModal h2").style.display = "none";
                    document.querySelector(".issue-buttons").style.display = "none";
                    customIssueInput.style.display = "none";
                    detailsInput.style.display = "none";
                    submitIssueBtn.style.display = "none";
                    closeButton.style.display = "none"; 
                    successMessageDiv.style.display = "flex"; 

                    setTimeout(async () => { 
                        issueModal.style.display = "none";
                        document.getElementById("mainContent").classList.remove("blurred"); 

                        if (currentClassroomElement) { 
                            await update(classroomRef, classroomUpdate);
                            console.log(`‚úÖ Classroom state updated to red for ${classroomPath}. Active log ID set: ${newLogId}. Issue card will appear.`);

                            currentClassroomElement.classList.remove("original");
                            currentClassroomElement.classList.add("blink-red", "clicked");
                            currentClassroomElement.dataset.tap = "1";
                        } else {
                            console.warn("currentClassroomElement was null when trying to update UI after modal close.");
                            await update(classroomRef, classroomUpdate);
                            console.log(`‚úÖ Classroom state updated to red (element was null) for ${classroomPath}. Active log ID set: ${newLogId}. Issue card will appear.`);
                        }

                        window.triggerGlobalSound(buildingName, classroomName);

                        successMessageDiv.style.display = "none"; 
                        submitIssueBtn.disabled = false; 
                        currentClassroomElement = null; 
                        
                        console.log("Issue reporting process complete.");

                    }, 2000); 

                } catch (error) {
                    console.error("‚ùå Error during issue submission (after logging, before/during modal success UI):", error);
                    alert("An error occurred while finalizing the issue report. Please check the classroom status or try again.");
                    submitIssueBtn.disabled = false;
                    issueModal.style.display = "none";
                    document.getElementById("mainContent").classList.remove("blurred");
                    document.querySelector("#issueModal h2").style.display = "block";
                    document.querySelector(".issue-buttons").style.display = "";
                    customIssueInput.style.display = "block";
                    detailsInput.style.display = "block";
                    submitIssueBtn.style.display = "inline-block";
                    closeButton.style.display = "flex";
                    successMessageDiv.style.display = "none";
                }
            });

            closeButton.addEventListener('click', function() {
                issueModal.style.display = "none";
                document.getElementById('mainContent').classList.remove("blurred");
                currentClassroomElement = null; 
                console.log("Issue modal closed manually.");
            });
        } 
    </script>

    <script type="module"> 
        const checkFirebaseHandle = setInterval(() => {
             if (window.firebaseTools && typeof window.logActivity === 'function' && window.campusPageId && window.campusPageId !== 'unknown_campus') {
                clearInterval(checkFirebaseHandle);
                initHandleIssueSystem();
                console.log(`‚úÖ Handle Issue System Initialized for ${window.campusPageId}.`);
            } else if (window.campusPageId === 'unknown_campus') {
                clearInterval(checkFirebaseHandle);
                console.error("üö® Handle Issue System NOT Initialized: Campus ID is unknown.");
            }
        }, 100);

        function initHandleIssueSystem() {
            const campusPrefix = window.campusPageId;
            const { database, ref, set, onValue, update, get, serverTimestamp } = window.firebaseTools;

            const handleModal = document.getElementById("handleIssueModal");
            const submitHandledIssueBtn = document.getElementById("submitHandledIssue");
            const staffNameSelect = document.getElementById("staffNameSelect");
            const successStaffNameSpan = document.getElementById("successStaffName"); 
            const handleIssueFormDiv = document.getElementById("handleIssueForm"); 
            const handleSuccessMessageDiv = document.getElementById("handleIssueSuccessMessage"); 
            const closeButton = document.querySelector("#handleIssueModal .close-button"); 

            let currentHandledClassroomElement = null;

            window.trackHandledClassroom = function(element) {
                currentHandledClassroomElement = element;
                console.log("Tracking classroom for handling:", element.innerText);
            };

            staffNameSelect.addEventListener("change", function () {
                submitHandledIssueBtn.disabled = !this.value || this.value.trim() === "";
            });

            submitHandledIssueBtn.addEventListener("click", async function() { 
                if (!currentHandledClassroomElement) {
                    console.error("‚ùå No classroom element reference found for handling.");
                    alert("An error occurred (no classroom tracked). Please close the modal and try again.");
                    return;
                }

                const staffName = staffNameSelect.value.trim();
                if (!staffName) {
                    alert("Please select your name.");
                    return; 
                }

                submitHandledIssueBtn.disabled = true; 
                console.log(`Handling issue for ${currentHandledClassroomElement.innerText} by ${staffName}...`);

                const classroomName = currentHandledClassroomElement.innerText;
                const buildingName = currentHandledClassroomElement.closest(".building-container").querySelector("h2").innerText;
                const classroomPath = `${campusPrefix}/classrooms/${buildingName}/${classroomName}`;
                const classroomRef = ref(database, classroomPath);

                let activeLogId = null;
                try {
                    const snapshot = await get(classroomRef); 
                    if (snapshot.exists()) {
                        activeLogId = snapshot.val().activeLogId; 
                    }
                } catch (error) {
                     console.error("‚ùå Error fetching classroom data for activeLogId:", error);
                     alert("Could not retrieve logging information for this classroom. Cannot proceed.");
                     submitHandledIssueBtn.disabled = false; 
                     return; 
                }

                if (!activeLogId) {
                    console.error(`‚ùå ActiveLogId not found for classroom: ${classroomPath}. Cannot log 'handled' action.`);
                    alert("Logging ID missing for this issue. Cannot mark as handled properly. Please report this inconsistency.");
                    submitHandledIssueBtn.disabled = false; 
                    return; 
                }
                console.log(`Found activeLogId: ${activeLogId}`);

                const logUpdateData = {
                    action: "ISSUE_HANDLED", 
                    building: buildingName,    
                    classroom: classroomName,
                    details: {
                        handledBy: staffName 
                    }
                };
                const updatedLogId = await window.logActivity(logUpdateData, activeLogId);

                if (!updatedLogId) {
                     console.error("‚ùå Failed to update activity log entry. Aborting handle action.");
                     alert("Error updating activity log. Handle action not fully completed.");
                     submitHandledIssueBtn.disabled = false;
                     return;
                }
                 console.log(`‚úÖ Activity log entry ${updatedLogId} updated with 'handled' action for ${campusPrefix}.`);

                const classroomUpdate = {
                    tapCount: 2, 
                    color: "yellow"
                };
                try {
                    await update(classroomRef, classroomUpdate); 
                    console.log(`‚úÖ Classroom state updated to yellow for ${classroomPath}.`);

                    const issuesRootPath = `${campusPrefix}/issues`;
                     try {
                         const issuesSnapshot = await get(ref(database, issuesRootPath)); 
                         if (issuesSnapshot.exists()) {
                             const issues = issuesSnapshot.val();
                             const updatesForIssuesNode = {}; 
                             let issueKeyToUpdate = null;

                             for (const key in issues) {
                                 if (issues[key] && issues[key].logId === activeLogId) {
                                     issueKeyToUpdate = key;
                                     break; 
                                 }
                             }

                             if (issueKeyToUpdate) {
                                 updatesForIssuesNode[`${issuesRootPath}/${issueKeyToUpdate}/handledBy`] = staffName;
                                 updatesForIssuesNode[`${issuesRootPath}/${issueKeyToUpdate}/handledTimestamp`] = serverTimestamp();
                                 updatesForIssuesNode[`${issuesRootPath}/${issueKeyToUpdate}/status`] = "handled"; 

                                 await update(ref(database), updatesForIssuesNode); 
                                 console.log(`‚úÖ Issue ${issueKeyToUpdate} in '${issuesRootPath}' node marked as handled by ${staffName}.`);
                             } else {
                                 console.warn(`‚ö†Ô∏è Could not find matching issue in '${issuesRootPath}' node for logId: ${activeLogId}`);
                             }
                         }
                     } catch (issueError) {
                         console.error(`‚ùå Error updating '${issuesRootPath}' node:`, issueError);
                     }

                    currentHandledClassroomElement.classList.remove("blink-red", "clicked");
                    currentHandledClassroomElement.classList.add("blink-yellow");
                    currentHandledClassroomElement.dataset.tap = "2"; 

                    handleSuccessMessageDiv.innerHTML = `Issue handled by <strong>${staffName}</strong>`;
                    handleIssueFormDiv.style.display = "none"; 
                    handleSuccessMessageDiv.style.display = "block"; 
                    closeButton.style.display = "none"; 

                    setTimeout(() => {
                        handleModal.style.display = "none"; 
                        document.getElementById("mainContent").classList.remove("blurred"); 

                        handleIssueFormDiv.style.display = ""; 
                        handleSuccessMessageDiv.style.display = "none"; 
                        closeButton.style.display = "flex"; 
                        staffNameSelect.value = ""; 
                        submitHandledIssueBtn.disabled = true; 
                        currentHandledClassroomElement = null; 
                        console.log("Handle issue process complete.");
                    }, 2000); 

                    // --- NEW: Trigger notification for End-User (Issue Handled) ---
                    // This assumes you store some identifier for the reporting user
                    // alongside the issue (e.g., their FCM token, or a user ID to look up their token).
                    // For now, we'll signal the backend about this event.
                    const originalIssueSnapshot = await get(ref(database, `${campusPrefix}/issues/${activeLogId}`)); // Fetch original issue data to get reporter details
                    const originalIssueData = originalIssueSnapshot.val();

                    const notificationTriggerRef = ref(database, `notificationTriggers/issueHandled`);
                    await push(notificationTriggerRef, {
                        issueId: activeLogId,
                        building: buildingName,
                        classroom: classroomName,
                        status: "handled",
                        reportedBy: originalIssueData?.username || 'unknown', // Assuming username is stored
                        timestamp: serverTimestamp(),
                        // If you have the user's FCM token, you'd include it here or a userId to look it up
                        // targetUserToken: originalIssueData?.reporterFcmToken // If you stored it
                    });
                    console.log("üîî Notification trigger sent for handled classroom issue.");
                    // --- END NEW ---

                } catch (error) {
                    console.error("‚ùå Error updating classroom state to yellow:", error);
                    alert("Error updating classroom status. The action was logged, but the button color might be wrong. Please refresh.");
                    submitHandledIssueBtn.disabled = false; 
                }
            });

            closeButton.addEventListener('click', function() {
                handleModal.style.display = "none";
                document.getElementById("mainContent").classList.remove("blurred");
                currentHandledClassroomElement = null; 
                staffNameSelect.value = "";
                submitHandledIssueBtn.disabled = true;
                handleIssueFormDiv.style.display = ""; 
                handleSuccessMessageDiv.style.display = "none"; 
                console.log("Handle issue modal closed manually.");
            });
        } 
    </script>

<script type="module"> 
    const checkFirebaseDisplay = setInterval(() => {
        if (window.firebaseTools && window.firebaseTools.remove && typeof window.logActivity === 'function' && window.campusPageId && window.campusPageId !== 'unknown_campus') {
            clearInterval(checkFirebaseDisplay);
            initIssueDisplaySystem();
            console.log(`‚úÖ Issue Display System Initialized for ${window.campusPageId}.`);
        } else if (window.campusPageId === 'unknown_campus') {
            clearInterval(checkFirebaseDisplay);
            console.error("üö® Issue Display System NOT Initialized: Campus ID is unknown.");
        }
    }, 100);

    function initIssueDisplaySystem() {
        const campusPrefix = window.campusPageId;
        const { database, ref, onValue, update, remove } = window.firebaseTools;

        const urlParams = new URLSearchParams(window.location.search);
        const fromBatch = urlParams.get('fromBatch') === 'true';
        const batchBuilding = urlParams.get('building');
        const batchLevel = urlParams.get('level')?.replace('Level ', ''); 
        const batchRoom = urlParams.get('room');
        const viewOnly = urlParams.get('viewOnly') === 'true'; 

        const issuesPath = `${campusPrefix}/issues`;
        const classroomsPath = `${campusPrefix}/classrooms`;
        const issuesRef = ref(database, issuesPath);
        const classroomsRef = ref(database, classroomsPath); 

        let classroomStates = {};
        onValue(classroomsRef, (snapshot) => {
            classroomStates = snapshot.val() || {};
            updateIssueDisplay();
        });

        let issueListenerActive = false; 
        function updateIssueDisplay() {
             if (issueListenerActive) return; 
             issueListenerActive = true;

             onValue(issuesRef, (issuesSnapshot) => {
                issueListenerActive = false; 
                const issuesData = issuesSnapshot.val() || {}; 
                console.log(`Received issues data for ${campusPrefix}:`, issuesData);

                const issuesByLevelKey = {}; 
                Object.entries(issuesData).forEach(([issueId, issue]) => {
                    if (!issue || !issue.building || !issue.classroom || !issue.level) {
                        console.warn("Skipping invalid issue data:", issueId, issue);
                        return;
                    }
                    const classroomState = classroomStates[issue.building]?.[issue.classroom];
                    if (classroomState && classroomState.color !== "original") {
                        if (fromBatch && !(issue.building === batchBuilding && String(issue.level) === String(batchLevel) && issue.classroom === batchRoom)) {
                            return; 
                        }
                        const key = `${issue.building}-${issue.level}`;
                        if (!issuesByLevelKey[key]) issuesByLevelKey[key] = [];
                        issuesByLevelKey[key].push({ ...issue, _id: issueId, logId: issue.logId || null });
                    }
                });
                console.log(`Processed issues for display (${campusPrefix}):`, issuesByLevelKey);

                const allLevelIssueContainers = document.querySelectorAll('.level-issues-container');
                allLevelIssueContainers.forEach(container => {
                     const levelKey = container.dataset.levelKey;
                     if (!issuesByLevelKey[levelKey] || issuesByLevelKey[levelKey].length === 0) {
                         container.innerHTML = ''; 
                         container.style.display = 'none'; 
                     } else {
                         container.style.display = ''; 
                     }
                     container.innerHTML = '';
                 });

                Object.entries(issuesByLevelKey).forEach(([levelKey, issuesArray]) => {
                    const [buildingName, level] = levelKey.split('-');
                    let targetContainer = null;
                    document.querySelectorAll('.building-container').forEach(buildingDiv => {
                        if (buildingDiv.querySelector('h2')?.innerText === buildingName) {
                            buildingDiv.querySelectorAll('.level-container').forEach(levelDiv => {
                                const levelTitleElement = levelDiv.querySelector('.level-title');
                                if (levelTitleElement && levelTitleElement.innerText.endsWith(level)) {
                                    let issuesContainer = levelDiv.querySelector('.level-issues-container');
                                    if (!issuesContainer) {
                                        issuesContainer = document.createElement('div');
                                        issuesContainer.className = 'level-issues-container';
                                        levelDiv.querySelector('.classroom-grid')?.insertAdjacentElement('afterend', issuesContainer);
                                    }
                                    issuesContainer.dataset.levelKey = levelKey; 
                                    targetContainer = issuesContainer;
                                }
                            });
                        }
                    });

                    if (targetContainer) {
                        targetContainer.innerHTML = ''; 
                        targetContainer.style.display = 'block'; 
                        issuesArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                        issuesArray.forEach(issueWithId => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'issue-message';
                            messageDiv.dataset.issueid = issueWithId._id;
                            messageDiv.dataset.logid = issueWithId.logId;
                            messageDiv.dataset.building = issueWithId.building;
                            messageDiv.dataset.classroom = issueWithId.classroom;

                            const timestamp = issueWithId.timestamp;
                            let formattedTime = "N/A";
                            if (timestamp) {
                                try {
                                    formattedTime = new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                                } catch (e) { console.error("Error formatting time:", e); }
                            }

                            const isHandled = !!issueWithId.handledBy;

                            messageDiv.innerHTML = `
                                <div class="issue-header">${issueWithId.building} ‚Ä¢ Level ${issueWithId.level || 'N/A'} ‚Ä¢ ${issueWithId.classroom}</div>
                                ${(issueWithId.username && issueWithId.username !== 'unknown') || (issueWithId.ip && issueWithId.ip !== 'unknown') ? `
                                    <div class="issue-meta">
                                        ${issueWithId.username !== 'unknown' ? `${issueWithId.username}` : ''}
                                        ${issueWithId.username !== 'unknown' && issueWithId.ip !== 'unknown' ? ' | ' : ''}
                                        ${issueWithId.ip !== 'unknown' ? `${issueWithId.ip}` : ''}
                                    </div>` : ''}
                                <div class="issue-type">${issueWithId.issues || 'N/A'}</div>
                                ${issueWithId.description ? `<div class="issue-description">${issueWithId.description}</div>` : ''}
                                <div class="issue-time">Reported: ${formattedTime}</div>
                                ${isHandled ? `<div class="handled-by">Handled by: ${issueWithId.handledBy}</div>` : ''}
                                <div class="issue-card-actions">
                                    <button class="cancel-issue-btn">Cancel</button>
                                </div>
                            `;
                            targetContainer.appendChild(messageDiv);

                            const handleButton = messageDiv.querySelector('.handle-issue-btn');
                            const cancelButton = messageDiv.querySelector('.cancel-issue-btn');

                            if (handleButton) {
                                if (isHandled) {
                                    handleButton.classList.add('solved-btn');
                                    handleButton.disabled = false; 
                                    handleButton.style.cursor = 'pointer'; 

                                    const newHandleButton = handleButton.cloneNode(true);
                                    handleButton.parentNode.replaceChild(newHandleButton, handleButton);

                                    newHandleButton.addEventListener('click', async () => {
                                        console.log(`Solved button clicked for issue: ${issueWithId._id} (Log ID: ${issueWithId.logId}) on ${campusPrefix}`);
                                        const issueIdToReset = messageDiv.dataset.issueid;
                                        const logIdToUpdate = messageDiv.dataset.logid;
                                        const buildingForReset = messageDiv.dataset.building;
                                        const classroomForReset = messageDiv.dataset.classroom;

                                        if (!issueIdToReset || !logIdToUpdate || !buildingForReset || !classroomForReset) {
                                            console.error("‚ùå Cannot reset: Missing required data attributes on the message card.");
                                            alert("Error: Could not get issue details to perform reset.");
                                            return;
                                        }
                                        
                                        const currentIssuePath = `${campusPrefix}/issues/${issueIdToReset}`;
                                        const currentClassroomPath = `${campusPrefix}/classrooms/${buildingForReset}/${classroomForReset}`;
                                        const issueRefToReset = ref(database, currentIssuePath);
                                        const classroomRefToReset = ref(database, currentClassroomPath);

                                        try {
                                            const logUpdateData = {
                                                action: "ISSUE_RESET_FROM_CARD", 
                                                building: buildingForReset,
                                                classroom: classroomForReset,
                                                details: {
                                                    resetIssueKey: issueIdToReset,
                                                    reason: "Clicked 'Solved' button on card"
                                                }
                                            };
                                            const updatedLogId = await window.logActivity(logUpdateData, logIdToUpdate);
                                            if (!updatedLogId) {
                                                 console.error("‚ùå Failed to update activity log for reset. State might become inconsistent.");
                                                 alert("Warning: Could not update activity log, but attempting to reset issue anyway.");
                                            } else {
                                                 console.log(`‚úÖ Activity log ${updatedLogId} updated with 'reset' action.`);
                                            }

                                            await remove(issueRefToReset);
                                            console.log(`‚úÖ Issue ${issueIdToReset} removed from '${currentIssuePath}' node.`);

                                            const classroomUpdate = {
                                                tapCount: 0,
                                                color: "original",
                                                activeLogId: null 
                                            };
                                            await update(classroomRefToReset, classroomUpdate);
                                            console.log(`‚úÖ Classroom ${currentClassroomPath} state reset and activeLogId removed.`);

                                        } catch (error) {
                                            console.error("‚ùå Error during reset process from card:", error);
                                            alert("An error occurred while resetting the issue. Please check the classroom status manually.");
                                        }
                                    });

                                } else if (viewOnly) {
                                    handleButton.disabled = true;
                                    handleButton.style.opacity = '0.5';
                                    handleButton.style.cursor = 'not-allowed';
                                    if (cancelButton) {
                                         cancelButton.disabled = true;
                                         cancelButton.style.opacity = '0.5';
                                         cancelButton.style.cursor = 'not-allowed';
                                     }
                                } else {
                                    handleButton.addEventListener('click', () => {
                                        console.log(`Handle button clicked for issue: ${issueWithId._id} (Classroom: ${issueWithId.building} ${issueWithId.classroom}) on ${campusPrefix}`);
                                        let foundClassroomElement = null;
                                        document.querySelectorAll('.building-container').forEach(buildingCont => {
                                            if (buildingCont.querySelector('h2')?.innerText === issueWithId.building) {
                                                buildingCont.querySelectorAll('.level-container').forEach(levelCont => {
                                                    const levelTitleElem = levelCont.querySelector('.level-title');
                                                    if (levelTitleElem && levelTitleElem.innerText.endsWith(String(issueWithId.level))) {
                                                         levelCont.querySelectorAll('.classroom').forEach(classroomElem => {
                                                            if (classroomElem.innerText === issueWithId.classroom) {
                                                                foundClassroomElement = classroomElem;
                                                            }
                                                        });
                                                    }
                                                });
                                            }
                                        });

                                        if (foundClassroomElement) {
                                             const currentState = classroomStates[issueWithId.building]?.[issueWithId.classroom]?.color;
                                             if (currentState === 'red') {
                                                window.trackHandledClassroom(foundClassroomElement); 
                                                const handleModal = document.getElementById("handleIssueModal");
                                                const handledClassroomNameSpan = document.getElementById("handledClassroomName");
                                                const staffSelect = document.getElementById("staffNameSelect");
                                                const submitHandledBtn = document.getElementById("submitHandledIssue");
                                                const handleForm = document.getElementById("handleIssueForm");
                                                const handleSuccessMsg = document.getElementById("handleIssueSuccessMessage");
                                                const handleCloseBtn = handleModal?.querySelector(".close-button");

                                                if (handleModal && handledClassroomNameSpan && staffSelect && submitHandledBtn && handleForm && handleSuccessMsg && handleCloseBtn) {
                                                    handledClassroomNameSpan.textContent = `${issueWithId.building} ${issueWithId.classroom}`;
                                                    handleModal.style.display = "flex";
                                                    document.getElementById("mainContent")?.classList.add("blurred");
                                                    handleForm.style.display = "";
                                                    handleSuccessMsg.style.display = "none";
                                                    staffSelect.value = "";
                                                    handleCloseBtn.style.display = "flex";
                                                    submitHandledBtn.disabled = true;
                                                    staffSelect.focus(); 
                                                } else {
                                                    console.error("‚ùå Could not find all necessary elements for the Handle Issue modal.");
                                                    alert("Error opening the handle issue dialog. Required elements missing.");
                                                }
                                             } else {
                                                  console.warn(`Handle button clicked, but classroom ${issueWithId.building} ${issueWithId.classroom} is in state '${currentState}' (expected 'red'). Handle modal not opened.`);
                                             }
                                        } else {
                                            console.error(`‚ùå Could not find the classroom element for ${issueWithId.building} Level ${issueWithId.level} ${issueWithId.classroom} in the DOM.`);
                                            alert(`Error: Could not find the classroom element for ${issueWithId.classroom}. Cannot open handle dialog.`);
                                        }
                                    });
                                }
                            } 

                            if (cancelButton) {
                                 if (viewOnly && !isHandled) {
                                 } else {
                                     cancelButton.disabled = false;
                                     cancelButton.style.opacity = '';
                                     cancelButton.style.cursor = '';
                                 }
                             }

                        }); 
                    } else {
                         console.warn(`Could not find or create display container for level key: ${levelKey} on ${campusPrefix}`);
                    }
                }); 
                 console.log(`‚úÖ Issue display updated for ${campusPrefix}.`);
            }, (error) => {
                 issueListenerActive = false; 
                 console.error(`‚ùå Error listening to issues node on ${campusPrefix}:`, error);
             });
         } 

         updateIssueDisplay(); 
    } 
</script>

    <script>
        // Handle Single Classroom Mode based on URL parameters
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const buildingParam = urlParams.get('building');
            const levelParam = urlParams.get('level'); // Expects format like "Level 2" or just "2"
            const roomParam = urlParams.get('room');
            const mode = urlParams.get('mode');
            const filterClassroomIssues = urlParams.get('filterClassroomIssues') === 'true'; // Check if issues should be filtered
            const viewOnly = urlParams.get('viewOnly') === 'true'; // Check for view-only mode

            // Activate single classroom mode only if all parameters are present
            if (mode === 'single' && buildingParam && levelParam && roomParam) {
                console.log(`Entering single classroom mode: ${buildingParam} / ${levelParam} / ${roomParam}`);
                document.body.classList.add('single-classroom-mode'); // Add class for potential global styling

                // Hide all building containers initially
                document.querySelectorAll('.building-container').forEach(building => {
                    building.style.display = 'none';
                });

                // Find and show only the requested building, level, and classroom
                let foundClassroom = false;
                const buildings = document.querySelectorAll('.building-container');
                const normalizedLevelParam = levelParam.replace('Level ', ''); // Get just the number

                buildings.forEach(building => {
                    const buildingName = building.querySelector('h2')?.innerText;
                    if (buildingName === buildingParam) {
                        building.style.display = 'block'; // Show the correct building

                        const levels = building.querySelectorAll('.level-container');
                        levels.forEach(level => {
                            const levelTitle = level.querySelector('.level-title')?.innerText;
                            // Check if level title *ends with* the normalized level number
                            if (levelTitle && levelTitle.endsWith(normalizedLevelParam)) {
                                level.style.display = 'block'; // Show the correct level

                                const classrooms = level.querySelectorAll('.classroom');
                                classrooms.forEach(classroom => {
                                    if (classroom.innerText === roomParam) {
                                        foundClassroom = true;
                                        classroom.style.display = 'block'; // Show the target classroom

                                        // Apply view-only restrictions if enabled
                                        if (viewOnly) {
                                            console.log("Applying view-only restrictions.");
                                            // Prevent clicks using CSS pointer-events (JS clicks might still work)
                                            classroom.style.pointerEvents = 'none';
                                            classroom.style.opacity = '0.7'; // Visual indication
                                            // Hide mute button specifically in view-only
                                            const muteButton = document.getElementById('muteButton');
                                            if (muteButton) muteButton.style.display = 'none';
                                             // Hide export button
                                             const exportButton = document.getElementById('exportLogButton');
                                             if (exportButton) exportButton.style.display = 'none';
                                        }
                                    } else {
                                        classroom.style.display = 'none'; // Hide other classrooms in this level
                                    }
                                });
                                // Hide the general issue container for the level in single mode if not filtering
                                if (!filterClassroomIssues) {
                                     const levelIssues = level.querySelector('.level-issues-container');
                                     if (levelIssues) levelIssues.style.display = 'none';
                                }

                            } else {
                                level.style.display = 'none'; // Hide other levels in this building
                            }
                        });
                    }
                });

                // Adjust layout and potentially filter issues if the classroom was found
                if (foundClassroom) {
                    console.log("Single classroom found, adjusting layout.");
                    // Adjust main layout padding, margins etc. for single view
                    const mainContent = document.querySelector('main');
                    if(mainContent) mainContent.style.padding = '10px'; // Reduce padding
                    const visibleBuilding = document.querySelector('.building-container[style*="display: block"]');
                    if(visibleBuilding) visibleBuilding.style.margin = '0 auto'; // Center building
                    const visibleLevel = document.querySelector('.level-container[style*="display: block"]');
                    if(visibleLevel) visibleLevel.style.margin = '0 auto'; // Center level
                    const classroomGrid = visibleLevel?.querySelector('.classroom-grid');
                    if(classroomGrid) classroomGrid.style.justifyContent = 'center'; // Center the single classroom button

                } else {
                    console.warn(`Single classroom mode failed: Classroom ${buildingParam}/${levelParam}/${roomParam} not found in HTML.`);
                }
            }

             const fromBatch = urlParams.get('fromBatch') === 'true';
             if (fromBatch && roomParam) {
                console.log("Applying batch mode styling for room:", roomParam);
                const style = document.createElement('style');
                 const normalizedLevelParam = levelParam.replace('Level ', '');
                style.textContent = `
                    .level-title[data-batch-mode]::after {
                        content: "- Classroom ${roomParam}"; 
                        font-weight: bold;
                        color: black; 
                        margin-left: 5px;
                    }
                    .classroom[data-batch-mode] {
                         font-weight: bold; 
                    }
                `;
                 document.head.appendChild(style);

                 document.querySelectorAll('.building-container').forEach(building => {
                     if (building.querySelector('h2')?.innerText === buildingParam) {
                         building.querySelectorAll('.level-container').forEach(level => {
                             const levelTitle = level.querySelector('.level-title');
                             if (levelTitle?.innerText.endsWith(normalizedLevelParam)) {
                                 levelTitle.setAttribute('data-batch-mode', 'true'); 
                                 level.querySelectorAll('.classroom').forEach(classroom => {
                                     if (classroom.innerText === roomParam) {
                                         classroom.setAttribute('data-batch-mode', 'true'); 
                                     }
                                 });
                             }
                         });
                     }
                 });
            }
        });
    </script>

    <script type="module"> 
        const checkFirebaseCancel = setInterval(() => {
            if (window.firebaseTools && typeof window.logActivity === 'function' && window.campusPageId && window.campusPageId !== 'unknown_campus') {
                clearInterval(checkFirebaseCancel);
                initCancelSystem();
                console.log(`‚úÖ Cancel Confirmation System Initialized for ${window.campusPageId}.`);
            } else if (window.campusPageId === 'unknown_campus') {
                clearInterval(checkFirebaseCancel);
                console.error("üö® Cancel Confirmation System NOT Initialized: Campus ID is unknown.");
            }
        }, 100);

        function initCancelSystem() {
            const campusPrefix = window.campusPageId;
            const { database, ref, set, get, update, remove } = window.firebaseTools;

            let activeIssueId = null; 
            let activeLogId = null;   
            let issueDetailsForLog = {}; 

            document.getElementById('mainContent').addEventListener('click', function(e) {
                if (e.target.classList.contains('cancel-issue-btn')) {
                    console.log("Cancel button clicked.");
                    const messageDiv = e.target.closest('.issue-message'); 
                    if (messageDiv) {
                        activeIssueId = messageDiv.dataset.issueid;
                        activeLogId = messageDiv.dataset.logid;

                        const headerText = messageDiv.querySelector('.issue-header')?.innerText || '';
                        const parts = headerText.split('‚Ä¢'); 
                        issueDetailsForLog.building = parts[0]?.trim();
                        issueDetailsForLog.classroom = parts[2]?.trim();

                        if (activeIssueId && activeLogId && issueDetailsForLog.building && issueDetailsForLog.classroom) {
                            console.log(`Preparing to cancel: Issue Key=${activeIssueId}, Log ID=${activeLogId} for ${campusPrefix}`);
                            document.getElementById('cancelConfirmModal').style.display = 'flex';
                            document.getElementById('mainContent').classList.add('blurred'); 
                        } else {
                            console.error("‚ùå Could not find necessary IDs (issueId, logId) or details on the message card.", messageDiv.dataset, issueDetailsForLog);
                            alert("Error: Cannot identify the issue to cancel. Required data missing.");
                            activeIssueId = null;
                            activeLogId = null;
                            issueDetailsForLog = {};
                        }
                    } else {
                         console.error("‚ùå Could not find parent '.issue-message' for the clicked cancel button.");
                    }
                }
            });

            window.handleCancelConfirmation = async (confirmed) => { 
                const confirmModal = document.getElementById('cancelConfirmModal');
                confirmModal.style.display = 'none'; 
                document.getElementById('mainContent').classList.remove('blurred'); 

                if (confirmed && activeIssueId && activeLogId && issueDetailsForLog.building && issueDetailsForLog.classroom) {
                    console.log(`‚úÖ User confirmed cancellation for Issue Key: ${activeIssueId}, Log ID: ${activeLogId} on ${campusPrefix}`);

                    const currentIssuePath = `${campusPrefix}/issues/${activeIssueId}`;
                    const currentClassroomPath = `${campusPrefix}/classrooms/${issueDetailsForLog.building}/${issueDetailsForLog.classroom}`;
                    const issueRefToCancel = ref(database, currentIssuePath); 
                    const classroomRefToReset = ref(database, currentClassroomPath); 

                    try {
                        const logUpdateData = {
                            action: "ISSUE_CANCELED", 
                            building: issueDetailsForLog.building, 
                            classroom: issueDetailsForLog.classroom,
                            details: {
                                canceledIssueKey: activeIssueId, 
                                reason: "Canceled via button"
                            }
                        };
                        const updatedLogId = await window.logActivity(logUpdateData, activeLogId);
                        if (!updatedLogId) {
                             console.error("‚ùå Failed to update activity log for cancellation. State might become inconsistent.");
                             alert("Warning: Could not update activity log, but attempting to cancel issue anyway.");
                        } else {
                             console.log(`‚úÖ Activity log ${updatedLogId} updated with 'canceled' action.`);
                        }

                        await remove(issueRefToCancel); 
                        console.log(`‚úÖ Issue ${activeIssueId} removed from '${currentIssuePath}' node.`);

                        const classroomUpdate = {
                            tapCount: 0,
                            color: "original",
                            activeLogId: null 
                        };
                        await update(classroomRefToReset, classroomUpdate); 
                        console.log(`‚úÖ Classroom ${currentClassroomPath} state reset and activeLogId removed.`);

                        console.log("‚úÖ Cancellation process completed successfully.");

                    } catch (error) {
                        console.error("‚ùå Error during cancellation process:", error);
                        alert("An error occurred while canceling the issue. Please check the classroom status manually and report the error.");
                    } finally {
                        activeIssueId = null;
                        activeLogId = null;
                        issueDetailsForLog = {};
                    }
                } else if (!confirmed) {
                     console.log("Cancellation aborted by user.");
                     activeIssueId = null;
                     activeLogId = null;
                     issueDetailsForLog = {};
                } else {
                     console.warn("Cancellation failed: Missing required IDs or confirmation state.");
                     activeIssueId = null;
                     activeLogId = null;
                     issueDetailsForLog = {};
                }
            }; 
        }
    </script>

    <script type="module"> 
        const checkFirebaseExport = setInterval(() => {
            if (window.firebaseTools && window.campusPageId && window.campusPageId !== 'unknown_campus') {
                clearInterval(checkFirebaseExport);
                initExportSystem(); 
                console.log(`‚úÖ Export Log System Initialized for ${window.campusPageId}.`);
            } else if (window.campusPageId === 'unknown_campus') {
                clearInterval(checkFirebaseExport);
                console.error("üö® Export Log System NOT Initialized: Campus ID is unknown.");
            }
        }, 100);

        function initExportSystem() {
           const campusPrefix = window.campusPageId;
           if (!window.firebaseTools || !window.firebaseTools.database || !window.firebaseTools.ref || !window.firebaseTools.get) {
                console.error("Firebase tools not available in initExportSystem. Cannot initialize.");
                return;
           }

           const { database, ref, get } = window.firebaseTools;

           const exportLogModal = document.getElementById('exportLogModal');
           const exportButton = document.getElementById('exportLogButton');
           const submitExportBtn = document.getElementById('submitExportLog');
           const buildingCheckboxesDiv = document.getElementById('exportBuildingCheckboxes');
           const classroomModeSelectionDiv = document.getElementById('exportClassroomModeSelection');
           const specificClassroomSelectionDiv = document.getElementById('exportSpecificClassroomSelection');
           const classroomCheckboxesDiv = document.getElementById('exportClassroomCheckboxes'); 
           const classroomModeAllRadio = document.getElementById('exportClassroomModeAll');
           const classroomModeChooseRadio = document.getElementById('exportClassroomModeChoose');
           const startDateInput = document.getElementById('exportStartDate');
           const endDateInput = document.getElementById('exportEndDate');
           const handledByInput = document.getElementById('exportHandledByInput');
           const statusMessage = document.getElementById('exportStatusMessage');
           const exportLogCloseButton = exportLogModal ? exportLogModal.querySelector('.close-button') : null;

           let buildingsData = {}; 

           if (!exportButton || !exportLogModal || !submitExportBtn || !buildingCheckboxesDiv || !classroomModeSelectionDiv || !specificClassroomSelectionDiv || !classroomCheckboxesDiv || !startDateInput || !endDateInput || !handledByInput || !statusMessage) {
              console.error("One or more required elements for the export system not found in the DOM.");
              if(exportButton) exportButton.disabled = true;
              return;
           }

           function updateClassroomCheckboxes() {
                const selectedBuildings = Array.from(buildingCheckboxesDiv.querySelectorAll('.export-building-cb:checked'))
                                                .map(cb => cb.value);
                const isAllBuildings = document.getElementById('export_building_all')?.checked || selectedBuildings.length === 0; 

                classroomCheckboxesDiv.innerHTML = ''; 

                const relevantRooms = new Set();
                if (isAllBuildings) {
                     Object.values(buildingsData).forEach(roomSet => roomSet.forEach(r => relevantRooms.add(r)));
                } else {
                     selectedBuildings.forEach(bName => {
                         if (buildingsData[bName]) {
                              buildingsData[bName].forEach(r => relevantRooms.add(r));
                         }
                     });
                }

                const sortedRooms = [...relevantRooms].sort((a, b) => {
                   const numA = parseInt(a); const numB = parseInt(b);
                   return (!isNaN(numA) && !isNaN(numB)) ? numA - numB : String(a).localeCompare(String(b));
                });

                if (sortedRooms.length > 0) {
                     const allRoomsDiv = document.createElement('div');
                     allRoomsDiv.style.fontWeight = 'bold'; 
                     const allRoomsCheckboxId = 'export_room_all_subset';
                     allRoomsDiv.innerHTML = `<input type="checkbox" id="${allRoomsCheckboxId}" value="all" class="export-classroom-all-cb"><label for="${allRoomsCheckboxId}"> All Selected Classrooms (${sortedRooms.length})</label>`;
                     classroomCheckboxesDiv.appendChild(allRoomsDiv);

                     sortedRooms.forEach(rName => {
                         const div = document.createElement('div');
                         const checkboxId = `export_room_${rName.replace(/[^a-zA-Z0-9_]/g, '_')}`;
                         div.innerHTML = `<input type="checkbox" id="${checkboxId}" value="${rName}" class="export-classroom-cb"><label for="${checkboxId}"> ${rName}</label>`;
                         classroomCheckboxesDiv.appendChild(div);
                     });

                     const allRoomsCheckbox = document.getElementById(allRoomsCheckboxId);
                     allRoomsCheckbox?.addEventListener('change', function() {
                        const isChecked = this.checked;
                        classroomCheckboxesDiv.querySelectorAll('.export-classroom-cb').forEach(cb => {
                            cb.checked = isChecked;
                        });
                     });
                     classroomCheckboxesDiv.querySelectorAll('.export-classroom-cb').forEach(cb => {
                          cb.addEventListener('change', function() {
                              if (!this.checked) {
                                  if (allRoomsCheckbox) allRoomsCheckbox.checked = false;
                              } else {
                                   const allChecked = Array.from(classroomCheckboxesDiv.querySelectorAll('.export-classroom-cb')).every(individualCb => individualCb.checked);
                                   if (allRoomsCheckbox) allRoomsCheckbox.checked = allChecked;
                              }
                          });
                     });
                } else {
                     classroomCheckboxesDiv.innerHTML = '<div><i>No classrooms found for selected building(s).</i></div>';
                }
           }

           function populateFilterOptions() {
               console.log(`Populating filter options for ${campusPrefix}...`);
               buildingCheckboxesDiv.innerHTML = '';
               classroomCheckboxesDiv.innerHTML = ''; 
               buildingsData = {}; 

               document.querySelectorAll(".building-container").forEach(bldgContainer => {
                   const buildingNameElement = bldgContainer.querySelector("h2");
                   const buildingName = buildingNameElement ? buildingNameElement.innerText.trim() : null;
                   if (buildingName) {
                       if (!buildingsData[buildingName]) buildingsData[buildingName] = new Set();
                       bldgContainer.querySelectorAll(".classroom").forEach(roomElement => {
                           const roomName = roomElement.innerText.trim();
                           if (roomName) buildingsData[buildingName].add(roomName);
                       });
                   }
               });
               console.log("Found Buildings/Rooms:", buildingsData);

               const buildingNames = Object.keys(buildingsData).sort();

               if (buildingNames.length > 0) {
                   const allBuildingsDiv = document.createElement('div');
                   allBuildingsDiv.style.fontWeight = 'bold';
                   const allBuildingsCheckboxId = 'export_building_all';
                   allBuildingsDiv.innerHTML = `<input type="checkbox" id="${allBuildingsCheckboxId}" value="all" class="export-building-all-cb"><label for="${allBuildingsCheckboxId}"> All Buildings</label>`;
                   buildingCheckboxesDiv.appendChild(allBuildingsDiv);

                   buildingNames.forEach(bName => {
                       const div = document.createElement('div');
                       const checkboxId = `export_building_${bName.replace(/[^a-zA-Z0-9_]/g, '_')}`;
                       div.innerHTML = `<input type="checkbox" id="${checkboxId}" value="${bName}" class="export-building-cb"><label for="${checkboxId}"> ${bName}</label>`;
                       buildingCheckboxesDiv.appendChild(div);
                   });

                   const allBuildingsCheckbox = document.getElementById(allBuildingsCheckboxId);
                   const individualBuildingCheckboxes = buildingCheckboxesDiv.querySelectorAll('.export-building-cb');

                   allBuildingsCheckbox?.addEventListener('change', function() {
                       const isChecked = this.checked;
                       individualBuildingCheckboxes.forEach(cb => cb.checked = isChecked);
                       updateClassroomCheckboxes(); 
                   });

                   individualBuildingCheckboxes.forEach(cb => {
                       cb.addEventListener('change', function() {
                           if (!this.checked) {
                               if(allBuildingsCheckbox) allBuildingsCheckbox.checked = false;
                           } else {
                               const allChecked = Array.from(individualBuildingCheckboxes).every(individualCb => individualCb.checked);
                                if(allBuildingsCheckbox) allBuildingsCheckbox.checked = allChecked;
                           }
                           updateClassroomCheckboxes(); 
                       });
                   });
               } else {
                    buildingCheckboxesDiv.innerHTML = '<div><i>No buildings found.</i></div>';
               }

               classroomModeAllRadio.checked = true; 
               specificClassroomSelectionDiv.style.display = 'none'; 
               updateClassroomCheckboxes(); 
           } 
           window.populateExportFilterOptions = populateFilterOptions; 

           classroomModeSelectionDiv.addEventListener('change', function(event) {
              if (event.target.type === 'radio' && event.target.name === 'classroomExportMode') {
                  if (event.target.value === 'choose') {
                      specificClassroomSelectionDiv.style.display = 'block'; 
                      updateClassroomCheckboxes(); 
                  } else {
                      specificClassroomSelectionDiv.style.display = 'none'; 
                  }
              }
           });

           if (exportButton) { 
                exportButton.addEventListener('click', function() {
                    console.log("Admin role confirmed. Opening export log modal directly.");
                    
                    // Call the function to populate filter options
                    if (typeof window.populateExportFilterOptions === 'function') {
                        window.populateExportFilterOptions();
                    } else {
                        console.error("populateExportFilterOptions function not found.");
                        alert("Error: Cannot populate export filters.");
                        return;
                    }

                    // Reset fields and show the main export modal
                    const handledByInput = document.getElementById('exportHandledByInput');
                    const startDateInput = document.getElementById('exportStartDate');
                    const endDateInput = document.getElementById('exportEndDate');
                    const statusMsg = document.getElementById('exportStatusMessage');
                    
                    if(handledByInput) handledByInput.value = '';
                    if(startDateInput) startDateInput.value = '';
                    if(endDateInput) endDateInput.value = '';
                    if(statusMsg) statusMsg.style.display = 'none';
                    if(submitExportBtn) submitExportBtn.disabled = false;

                    if (exportLogModal) {
                        exportLogModal.style.display = "flex";
                        document.getElementById("mainContent")?.classList.add("blurred");
                    }
                });
           }

           const formatActionTimestamp = (ts) => { 
                if (!ts) return 'N/A';
                try {
                    const date = new Date(ts);
                    if (isNaN(date.getTime())) return 'Pending...';
                    const offset = date.getTimezoneOffset() * 60000;
                    const localISOTime = new Date(date.getTime() - offset).toISOString();
                    return localISOTime.replace('T', ' ').substring(0, 19);
                } catch (e) { console.error("Error formatting ts:", ts, e); return 'Invalid Date'; }
            };

           const processLogCycleHistory = (logCycle, bldg, cls, exportArray, startTs, endTs, handledByFilter) => {
                if (!logCycle || typeof logCycle !== 'object' || !logCycle.actionHistory || !Array.isArray(logCycle.actionHistory)) {
                     console.warn(`Skipping invalid log cycle for ${bldg}/${cls}`); return false;
                }
                let cycleMatchesHandledBy = !handledByFilter;
                let actionsAddedFromCycle = 0;

                logCycle.actionHistory.forEach((actionDetail, index) => {
                     if (!actionDetail || typeof actionDetail !== 'object') return;
                     const actionTimestamp = actionDetail.timestamp;
                     if (!actionTimestamp || actionTimestamp < startTs || actionTimestamp > endTs) return;

                     if (handledByFilter && actionDetail.action === "ISSUE_HANDLED" && actionDetail.details?.handledBy) {
                          if (String(actionDetail.details.handledBy).trim().toLowerCase() === handledByFilter) {
                              cycleMatchesHandledBy = true;
                          }
                     }
                     if (!handledByFilter || cycleMatchesHandledBy) {
                          const exportRow = {
                               "Log Cycle ID": logCycle.logCycleId || 'N/A', "Building": logCycle.building || bldg, "Classroom": logCycle.classroom || cls,
                               "Action Sequence": index + 1, "Action Type": actionDetail.action || 'N/A',
                               "Action Timestamp (Local)": formatActionTimestamp(actionTimestamp),
                               "Details - Issues": actionDetail.details?.issues || '', "Details - Description": actionDetail.details?.description || '',
                               "Details - Reported By User": actionDetail.details?.reportedBy_User || '', "Details - Reported By IP": actionDetail.details?.reportedBy_IP || '',
                               "Details - Handled By": actionDetail.details?.handledBy || '', "Details - Cancel Reason": actionDetail.details?.reason || '',
                               "Initial Report Timestamp (Local)": formatActionTimestamp(logCycle.initialTimestamp), "Last Update Timestamp (Local)": formatActionTimestamp(logCycle.lastUpdatedTimestamp),
                          };
                          exportArray.push(exportRow);
                          actionsAddedFromCycle++;
                     }
                });
                return actionsAddedFromCycle > 0 && (!handledByFilter || cycleMatchesHandledBy);
            };

           submitExportBtn.addEventListener('click', async function() {
                const startDateValue = startDateInput.value;
                const endDateValue = endDateInput.value;
                const handledByValue = handledByInput.value.trim().toLowerCase(); 

                startDateError.style.display = 'none';
                endDateError.style.display = 'none';
                statusMessage.style.display = 'none';

                let isValid = true;
                if (!startDateValue) {
                    startDateError.style.display = 'block';
                    isValid = false;
                }
                if (!endDateValue) {
                    endDateError.style.display = 'block';
                    isValid = false;
                }
                if (!isValid) return;

                const startTimestamp = new Date(startDateValue + 'T00:00:00').getTime();
                const endTimestamp = new Date(endDateValue + 'T23:59:59.999').getTime();

                if (startTimestamp > endTimestamp) {
                    statusMessage.textContent = "Error: Start Date cannot be after End Date.";
                    statusMessage.style.color = 'red';
                    statusMessage.style.display = 'block';
                    return;
                }

                const allBuildingsChecked = document.getElementById('export_building_all')?.checked;
                let buildingsToInclude = allBuildingsChecked 
                    ? Object.keys(buildingsData)
                    : Array.from(buildingCheckboxesDiv.querySelectorAll('.export-building-cb:checked')).map(cb => cb.value);
                
                if (buildingsToInclude.length === 0) {
                    buildingsToInclude = Object.keys(buildingsData);
                }

                const isClassroomModeAll = classroomModeAllRadio.checked;
                let classroomsToInclude = [];
                if (!isClassroomModeAll) {
                    classroomsToInclude = Array.from(classroomCheckboxesDiv.querySelectorAll('.export-classroom-cb:checked')).map(cb => cb.value);
                }

                const logPath = `${campusPrefix}/activityLog`;
                const logRef = ref(database, logPath);
                submitExportBtn.disabled = true;
                statusMessage.textContent = "Fetching and processing log data...";
                statusMessage.style.color = 'blue';
                statusMessage.style.display = 'block';

                try {
                    const snapshot = await get(logRef);
                    if (!snapshot.exists()) {
                        statusMessage.textContent = `No log data found at path: ${logPath}`;
                        statusMessage.style.color = 'orange';
                        submitExportBtn.disabled = false;
                        return;
                    }

                    const allLogsData = snapshot.val();
                    const logArrayForExport = [];

                    for (const buildingName of buildingsToInclude) {
                        const classrooms = allLogsData[buildingName];
                        if (!classrooms) continue;

                        for (const classroomName in classrooms) {
                            if (!isClassroomModeAll && !classroomsToInclude.includes(classroomName)) {
                                continue;
                            }
                            const logCycles = classrooms[classroomName];
                            if (logCycles) {
                                for (const logCycleId in logCycles) {
                                    processLogCycleHistory(logCycles[logCycleId], buildingName, classroomName, logArrayForExport, startTimestamp, endTimestamp, handledByValue);
                                }
                            }
                        }
                    }

                    if (logArrayForExport.length === 0) {
                        statusMessage.textContent = `No logs found matching the specified criteria.`;
                        statusMessage.style.color = 'orange';
                        submitExportBtn.disabled = false;
                        return;
                    }

                    logArrayForExport.sort((a, b) => {
                        const buildComp = String(a["Building"]).localeCompare(String(b["Building"])); if (buildComp !== 0) return buildComp;
                        const roomComp = String(a["Classroom"]).localeCompare(String(b["Classroom"])); if (roomComp !== 0) return roomComp;
                        const idComp = String(a["Log Cycle ID"]).localeCompare(String(b["Log Cycle ID"])); if (idComp !== 0) return idComp;
                        return a["Action Sequence"] - b["Action Sequence"];
                    });

                    // --- EXCEL EXPORT LOGIC ---
                    const worksheet = XLSX.utils.json_to_sheet(logArrayForExport);

                    // --- START: STYLING THE EXCEL SHEET ---
                    // 1. Define styles for each action type
                    const headerStyle = {
                        font: { name: "Arial", sz: 12, bold: true, color: { rgb: "FFFFFFFF" } }, // White, Bold
                        fill: { fgColor: { rgb: "FF016751" } }, // LAU Green Background
                        alignment: { horizontal: "center", vertical: "center" }
                    };

                    const reportedStyle = {
                        font: { color: { rgb: "FF9C0006" } }, // Dark Red Font
                        fill: { fgColor: { rgb: "FFFFC7CE" } }  // Light Red Fill
                    };

                    const handledStyle = {
                        font: { color: { rgb: "FF9C6500" } }, // Dark Yellow/Orange Font
                        fill: { fgColor: { rgb: "FFFFEB9C" } }  // Light Yellow Fill
                    };
                    
                    const solvedStyle = {
                        font: { color: { rgb: "FF006100" } }, // Dark Green Font
                        fill: { fgColor: { rgb: "FFC6EFCE" } }  // Light Green Fill
                    };

                    const canceledStyle = {
                        font: { color: { rgb: "FF707070" } }, // Dark Gray Font
                        fill: { fgColor: { rgb: "FFD3D3D3" } }  // Light Gray Fill
                    };

                    const defaultCellStyle = {
                        font: { name: "Arial", sz: 11, color: { rgb: "FF000000" } } // Standard black font
                    };

                    // 2. Apply styles to the header row
                    const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
                    for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({ r: 0, c: C });
                        if (!worksheet[address]) continue;
                        worksheet[address].s = headerStyle;
                    }

                    // 3. Apply styles to data rows based on "Action Type"
                    logArrayForExport.forEach((logEntry, index) => {
                        const rowIndex = index + 1; // data starts at row 2
                        const actionType = logEntry["Action Type"];

                        let rowStyle;
                        switch (actionType) {
                            case "ISSUE_REPORTED":
                                rowStyle = reportedStyle;
                                break;
                            case "ISSUE_HANDLED":
                                rowStyle = handledStyle;
                                break;
                            case "ISSUE_SOLVED":
                            case "ISSUE_RESET_FROM_CARD": // Treat reset as solved
                            case "STATE_RESET_FROM_HANDLED": // Legacy support
                                rowStyle = solvedStyle;
                                break;
                            case "ISSUE_CANCELED":
                                rowStyle = canceledStyle;
                                break;
                            default:
                                rowStyle = defaultCellStyle;
                                break;
                        }

                        // Apply the selected style to all cells in the current row
                        for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                            const address = XLSX.utils.encode_cell({ r: rowIndex, c: C });
                            if (!worksheet[address]) continue;
                            
                            if (!worksheet[address].s) worksheet[address].s = {};
                            Object.assign(worksheet[address].s, rowStyle);
                        }
                    });
                    // --- END: STYLING THE EXCEL SHEET ---
                                        
                    // Auto-fit column widths
                    const objectMaxLength = [];
                    logArrayForExport.forEach(obj => {
                        Object.entries(obj).forEach(([key, value], index) => {
                            const valLength = value ? String(value).length : 0;
                            const keyLength = key ? String(key).length : 0;
                            objectMaxLength[index] = Math.max(objectMaxLength[index] || 0, valLength, keyLength);
                        });
                    });
                    worksheet['!cols'] = objectMaxLength.map(w => ({ wch: w + 2 }));

                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Activity Log');

                    let filename = `activity_log_${campusPrefix}`;
                    filename += allBuildingsChecked ? '_Bldg[All]' : `_Bldg[${buildingsToInclude.length}]`;
                    if (isClassroomModeAll) {
                        filename += '_Room[All]';
                    } else {
                        filename += `_Room[${classroomsToInclude.length}]`;
                    }
                    filename += `_${startDateValue}_to_${endDateValue}`;
                    if (handledByValue) filename += `_by_${handledByInput.value.trim().replace(/[^a-z0-9_]/gi, '_')}`;
                    filename += '.xlsx'; // Use .xlsx extension

                    XLSX.writeFile(workbook, filename);
                    // --- END EXCEL EXPORT LOGIC ---

                    statusMessage.textContent = `Export successful! ${logArrayForExport.length} entries downloaded.`;
                    statusMessage.style.color = 'green';
                    setTimeout(closeExportLogModal, 2500);

                } catch (error) {
                    console.error(`‚ùå Error during export for ${campusPrefix}:`, error);
                    statusMessage.textContent = "An error occurred during export. Check console.";
                    statusMessage.style.color = 'red';
                } finally {
                    submitExportBtn.disabled = false;
                }
           });


           function closeExportLogModal() {
               if (exportLogModal) {
                   exportLogModal.style.display = 'none';
                   document.getElementById("mainContent")?.classList.remove("blurred");
                   if(buildingCheckboxesDiv) buildingCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                   if(classroomModeAllRadio) classroomModeAllRadio.checked = true;
                   if(specificClassroomSelectionDiv) specificClassroomSelectionDiv.style.display = 'none';
                   if(classroomCheckboxesDiv) classroomCheckboxesDiv.innerHTML = ''; 
                   if(startDateInput) startDateInput.value = '';
                   if(endDateInput) endDateInput.value = '';
                   if(handledByInput) handledByInput.value = '';
                   if(statusMessage) statusMessage.style.display = 'none';
                   if(submitExportBtn) submitExportBtn.disabled = false;
               }
           }

           if (exportLogCloseButton) exportLogCloseButton.addEventListener('click', closeExportLogModal);
           else console.warn("Close button not found for export log modal.");

       }
    </script>

    <script>
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('close-x') || e.target.closest('.close-button')) {
                const modal = e.target.closest('.modal');
                if (modal) {
                    console.log(`Closing modal: ${modal.id}`);

                    if (modal.id === 'authModal') {
                        window.location.href = 'index.html'; // Redirect to index.html
                        return; // Stop further execution for this modal
                    }
                    modal.style.display = 'none'; 
                    document.getElementById('mainContent')?.classList.remove('blurred');

                    if (modal.id === 'handleIssueModal') {
                        document.getElementById("handleIssueForm").style.display = "";
                        document.getElementById("handleIssueSuccessMessage").style.display = "none";
                        document.getElementById("staffNameSelect").value = "";
                        document.getElementById("submitHandledIssue").disabled = true;
                    }
                    if (modal.id === 'issueModal') {
                        document.querySelector("#issueModal .issue-buttons").style.display = "";
                        document.getElementById("customIssue").style.display = "block";
                        document.getElementById("issueDetails").style.display = "block";
                        document.getElementById("submitIssue").style.display = "inline-block";
                        document.getElementById("successMessage").style.display = "none";
                        document.querySelector("#issueModal .close-button").style.display = "flex";
                    }
                    if (modal.id === 'cancelConfirmModal') {
                        // window.activeIssueId = null; // If global, clear in cancel system itself
                        // window.activeLogId = null;
                        // window.issueDetailsForLog = {};
                    }
                
                    if (modal.id === 'exportLogModal') {
                        // Reset export log modal fields (this logic might also be in initExportSystem or a dedicated close function)
                        const buildingCheckboxesDiv = document.getElementById('exportBuildingCheckboxes');
                        const classroomModeAllRadio = document.getElementById('exportClassroomModeAll');
                        const specificClassroomSelectionDiv = document.getElementById('exportSpecificClassroomSelection');
                        const classroomCheckboxesDiv = document.getElementById('exportClassroomCheckboxes');
                        const startDateInput = document.getElementById('exportStartDate');
                        const endDateInput = document.getElementById('exportEndDate');
                        const handledByInput = document.getElementById('exportHandledByInput');
                        const statusMessage = document.getElementById('exportStatusMessage');
                        const submitExportBtn = document.getElementById('submitExportLog');

                        if(buildingCheckboxesDiv) buildingCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                        if(classroomModeAllRadio) classroomModeAllRadio.checked = true;
                        if(specificClassroomSelectionDiv) specificClassroomSelectionDiv.style.display = 'none';
                        if(classroomCheckboxesDiv) classroomCheckboxesDiv.innerHTML = '';
                        if(startDateInput) startDateInput.value = '';
                        if(endDateInput) endDateInput.value = '';
                        if(handledByInput) handledByInput.value = '';
                        if(statusMessage) statusMessage.style.display = 'none';
                        if(submitExportBtn) submitExportBtn.disabled = false;
                    }
                }
            }
        });
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch((error) => {
            console.error('Service Worker registration failed:', error);
            });
        });
    }
    </script>
</body>
</html>